<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AIèŠå¤§ - Mobile</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.10);
      --card2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --line: rgba(255,255,255,.12);
      --accent: #5eead4;

      --radius-xl: 22px;
      --radius-lg: 16px;

      --dock-h: 82px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
    }

    html,body{
      height:100%;
      background: var(--bg);
      margin:0;
      font-family: var(--font);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(94,234,212,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 30%, rgba(99,102,241,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 32%),
        var(--bg);
      padding-bottom: calc(var(--dock-h) + var(--safe-b));
    }

    /* Top status cloud */
    .top{
      padding-top: calc(10px + var(--safe-t));
      padding-left: 14px;
      padding-right: 14px;
    }

    .cloud{
      position:relative;
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .cloud::before{
      content:"";
      position:absolute;
      inset:-60px -40px auto -40px;
      height: 160px;
      background:
        radial-gradient(60px 46px at 18% 72%, rgba(255,255,255,.16), transparent 70%),
        radial-gradient(72px 52px at 44% 64%, rgba(255,255,255,.14), transparent 72%),
        radial-gradient(64px 48px at 70% 74%, rgba(255,255,255,.12), transparent 72%),
        radial-gradient(66px 50px at 88% 62%, rgba(255,255,255,.10), transparent 72%);
      filter: blur(0px);
      pointer-events:none;
    }

    .statusRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      position:relative;
    }
    .timeBox .time{
      font-size: 34px;
      line-height: 1;
      font-weight: 760;
      letter-spacing: .5px;
    }
    .timeBox .date{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .weatherBox{
      text-align:right;
    }
    .weatherBox .city{
      font-size: 14px;
      font-weight: 650;
    }
    .weatherBox .weather{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Home content */
    .home{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 14px 12px;
      margin-top: 4px;
    }

    .appIcon{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .iconTile{
      width: 62px;
      height: 62px;
      border-radius: 16px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
      display:grid;
      place-items:center;
      overflow:hidden;
      position:relative;
    }
    .iconTile::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, rgba(255,255,255,.12), transparent 55%);
      pointer-events:none;
    }
    .iconLabel{
      font-size: 12px;
      color: rgba(255,255,255,.82);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 13px;
    }

    /* Dock */
    .dock{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: calc(var(--dock-h) + var(--safe-b));
      padding: 10px 14px calc(10px + var(--safe-b));
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none; /* allow modal click-through control */
      z-index: 50;
    }
    .dockBar{
      width: min(520px, 100%);
      height: var(--dock-h);
      border-radius: 26px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-around;
      pointer-events:auto;
    }
    .dockBtn{
      width: 88px;
      height: 62px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      border-radius: 18px;
      border: 0;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
    }
    .dockBtn:active{ transform: scale(.98); }

    .dockIcon{
      width: 28px; height: 28px;
      border-radius: 10px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      font-size: 14px;
      color: rgba(255,255,255,.92);
    }
    .dockLabel{
      font-size: 12px;
      color: rgba(255,255,255,.82);
    }

    /* Drawer modal */
    .overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 0 12px calc(var(--dock-h) + var(--safe-b) + 10px);
      z-index: 60;
    }
    .overlay.show{ display:flex; }

    .drawer{
      width: min(680px, 100%);
      border-radius: 22px;
      background: rgba(20,24,38,.86);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .drawerHd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
    }
    .drawerTitle{
      font-weight: 750;
      letter-spacing: .2px;
    }
    .drawerClose{
      border:0;
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-family: var(--font);
    }
    .drawerBody{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
    }
    .field input, .field textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      font-family: var(--font);
      outline: none;
      box-sizing: border-box;
    }
    textarea{ min-height: 120px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
    }
    .row > *{ flex:1; }

    .btnRow{
      display:flex;
      gap: 10px;
      margin-top: 4px;
    }
    .btn{
      flex:1;
      border:0;
      border-radius: 14px;
      padding: 11px 12px;
      background: rgba(94,234,212,.18);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(94,234,212,.25);
      font-family: var(--font);
      font-weight: 700;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.12);
      font-weight: 650;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* Chat page */
    .chat{
      display:none;
      flex-direction:column;
      min-height: calc(100vh - var(--dock-h) - var(--safe-b));
    }
    .chat.show{ display:flex; }

    .chatHd{
      padding: 10px 14px 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.70));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      z-index: 10;
    }
    .backBtn{
      border:0;
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-family: var(--font);
    }
    .chatTitle{
      font-weight: 750;
    }

    .chatBody{
      flex:1;
      padding: 10px 12px 14px;
      overflow:auto;
    }
    .msg{
      display:flex;
      margin: 10px 0;
    }
    .msg.me{ justify-content:flex-end; }
    .bubble{
      max-width: 76%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      line-height: 1.45;
      font-size: 14px;
      word-break: break-word;
    }
    .msg.me .bubble{
      background: rgba(94,234,212,.16);
      border-color: rgba(94,234,212,.20);
    }

    .chatFt{
      padding: 10px 12px calc(10px + var(--safe-b));
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(11,18,32,.72);
      backdrop-filter: blur(10px);
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    .chatFt textarea{
      min-height: 42px;
      max-height: 120px;
      resize: none;
    }
    .genBtn{
      width: 92px;
      border:0;
      border-radius: 14px;
      padding: 12px 10px;
      background: rgba(99,102,241,.22);
      border: 1px solid rgba(99,102,241,.26);
      color: rgba(255,255,255,.92);
      font-family: var(--font);
      font-weight: 760;
    }
    .genBtn:disabled{ opacity:.55; }

    /* User custom CSS injection */
    #presetStyle, #beautyStyle { }
  </style>

  <style id="presetStyle"></style>
  <style id="beautyStyle"></style>
</head>

<body>
  <div class="app" id="app">
    <div class="top">
      <div class="cloud" id="cloud">
        <div class="statusRow">
          <div class="timeBox">
            <div class="time" id="timeText">--:--</div>
            <div class="date" id="dateText">----</div>
          </div>
          <div class="weatherBox">
            <div class="city" id="cityText">åŸå¸‚æœªè®¾ç½®</div>
            <div class="weather" id="weatherText">å¤©æ°”æœªè®¾ç½®</div>
          </div>
        </div>
      </div>
    </div>

    <div class="home" id="home">
      <div class="pill">æç¤ºï¼šç‚¹â€œç§èŠâ€è¿›å…¥å¾®ä¿¡å¯¹è¯ï¼›åº•éƒ¨å¯æ”¹è®¾ç½®/é¢„è®¾/ç¾åŒ–</div>

      <div class="grid">
        <div class="appIcon" id="openChat">
          <div class="iconTile">
            <span style="font-size:22px">ğŸ’¬</span>
          </div>
          <div class="iconLabel">ç§èŠ</div>
        </div>

        <div class="appIcon">
          <div class="iconTile"><span style="font-size:20px">ğŸ“Œ</span></div>
          <div class="iconLabel">å ä½</div>
        </div>
        <div class="appIcon">
          <div class="iconTile"><span style="font-size:20px">ğŸ§©</span></div>
          <div class="iconLabel">å ä½</div>
        </div>
        <div class="appIcon">
          <div class="iconTile"><span style="font-size:20px">ğŸ—‚ï¸</span></div>
          <div class="iconLabel">å ä½</div>
        </div>
      </div>
    </div>

    <div class="chat" id="chat">
      <div class="chatHd">
        <button class="backBtn" id="backHome">è¿”å›</button>
        <div class="chatTitle" id="chatTitle">å¾®ä¿¡ç§èŠ</div>
      </div>
      <div class="chatBody" id="chatBody"></div>
      <div class="chatFt">
        <textarea id="inputBox" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" rows="1"></textarea>
        <button class="genBtn" id="genBtn">ç”Ÿæˆ</button>
      </div>
    </div>

    <div class="dock">
      <div class="dockBar">
        <button class="dockBtn" data-drawer="settings">
          <div class="dockIcon">âš™ï¸</div>
          <div class="dockLabel">è®¾ç½®</div>
        </button>
        <button class="dockBtn" data-drawer="beauty">
          <div class="dockIcon">ğŸ¨</div>
          <div class="dockLabel">ç¾åŒ–</div>
        </button>
        <button class="dockBtn" data-drawer="preset">
          <div class="dockIcon">ğŸ§¾</div>
          <div class="dockLabel">é¢„è®¾</div>
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer Overlay -->
  <div class="overlay" id="overlay">
    <div class="drawer" id="drawer">
      <div class="drawerHd">
        <div class="drawerTitle" id="drawerTitle">è®¾ç½®</div>
        <button class="drawerClose" id="drawerClose">å…³é—­</button>
      </div>
      <div class="drawerBody" id="drawerBody"></div>
    </div>
  </div>

<script>
  const LS_KEYS = {
    settings: "aichatda_settings_v1",
    preset: "aichatda_preset_v1",
    beauty: "aichatda_beauty_v1",
    chat: "aichatda_chat_v1",
  };

  const state = {
    settings: {
      baseUrl: "https://api.openai.com",
      apiKey: "",
      model: "gpt-4.1-mini",
      city: "",
      weather: ""
    },
    preset: {
      systemRulesText: "",
      presetCss: ""
    },
    beauty: {
      beautyCss: ""
    },
    chat: {
      messages: [] // {role:'user'|'assistant', content:string, ts:number}
    }
  };

  function loadLS(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEYS.settings) || "null");
      const p = JSON.parse(localStorage.getItem(LS_KEYS.preset) || "null");
      const b = JSON.parse(localStorage.getItem(LS_KEYS.beauty) || "null");
      const c = JSON.parse(localStorage.getItem(LS_KEYS.chat) || "null");
      if(s) Object.assign(state.settings, s);
      if(p) Object.assign(state.preset, p);
      if(b) Object.assign(state.beauty, b);
      if(c && Array.isArray(c.messages)) state.chat.messages = c.messages;
    }catch(e){}
  }

  function saveLS(){
    localStorage.setItem(LS_KEYS.settings, JSON.stringify(state.settings));
    localStorage.setItem(LS_KEYS.preset, JSON.stringify(state.preset));
    localStorage.setItem(LS_KEYS.beauty, JSON.stringify(state.beauty));
    localStorage.setItem(LS_KEYS.chat, JSON.stringify(state.chat));
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function weekdayCN(d){
    const map = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
    return map[d.getDay()];
  }

  function refreshTopBar(){
    const now = new Date();
    const hh = pad2(now.getHours());
    const mm = pad2(now.getMinutes());
    document.getElementById("timeText").textContent = `${hh}:${mm}`;
    document.getElementById("dateText").textContent =
      `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())} ${weekdayCN(now)}`;

    document.getElementById("cityText").textContent = state.settings.city ? state.settings.city : "åŸå¸‚æœªè®¾ç½®";
    document.getElementById("weatherText").textContent = state.settings.weather ? state.settings.weather : "å¤©æ°”æœªè®¾ç½®";
  }

  function showDrawer(kind){
    const overlay = document.getElementById("overlay");
    const title = document.getElementById("drawerTitle");
    const body = document.getElementById("drawerBody");
    overlay.classList.add("show");
    body.innerHTML = "";

    if(kind === "settings"){
      title.textContent = "è®¾ç½®ï¼ˆOpenAIå…¼å®¹ï¼‰";
      body.appendChild(renderSettings());
    }else if(kind === "preset"){
      title.textContent = "é¢„è®¾ï¼ˆè§„åˆ™ + æ–‡é£CSSï¼‰";
      body.appendChild(renderPreset());
    }else if(kind === "beauty"){
      title.textContent = "ç¾åŒ–ï¼ˆç•Œé¢CSSï¼‰";
      body.appendChild(renderBeauty());
    }
  }

  function hideDrawer(){
    document.getElementById("overlay").classList.remove("show");
  }

  function el(tag, attrs={}, children=[]){
    const node = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k === "class") node.className = v;
      else if(k === "text") node.textContent = v;
      else if(k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
      else node.setAttribute(k, v);
    }
    for(const c of children) node.appendChild(c);
    return node;
  }

  function field(label, input){
    return el("div",{class:"field"},[
      el("label",{text:label}),
      input
    ]);
  }

  function applyStyles(){
    document.getElementById("presetStyle").textContent = state.preset.presetCss || "";
    document.getElementById("beautyStyle").textContent = state.beauty.beautyCss || "";
  }

  function renderSettings(){
    const baseUrl = el("input",{value: state.settings.baseUrl, placeholder:"https://api.openai.com"});
    const apiKey = el("input",{value: state.settings.apiKey, placeholder:"sk-...ï¼ˆå‰ç«¯ä¼šæš´éœ²ï¼Œæ…ç”¨ï¼‰"});
    const model  = el("input",{value: state.settings.model, placeholder:"gpt-4.1-mini"});
    const city   = el("input",{value: state.settings.city, placeholder:"ä¾‹å¦‚ï¼šä¸Šæµ·"});
    const weather= el("input",{value: state.settings.weather, placeholder:"ä¾‹å¦‚ï¼šå¤šäº‘ 12~18â„ƒ"});

    const wrap = el("div",{},[
      el("div",{class:"row"},[
        field("Base URL", baseUrl),
        field("Model", model),
      ]),
      field("API Key", apiKey),
      el("div",{class:"row"},[
        field("æ‰€åœ¨åŸå¸‚ï¼ˆå¯è¢«APIè¯»å–ï¼‰", city),
        field("å¤©æ°”ï¼ˆå¯è¢«APIè¯»å–ï¼‰", weather),
      ]),
      el("div",{class:"btnRow"},[
        el("button",{class:"btn", text:"ä¿å­˜å¹¶ç”Ÿæ•ˆ", onclick: ()=>{
          state.settings.baseUrl = baseUrl.value.trim() || "https://api.openai.com";
          state.settings.apiKey = apiKey.value.trim();
          state.settings.model = model.value.trim() || "gpt-4.1-mini";
          state.settings.city = city.value.trim();
          state.settings.weather = weather.value.trim();
          saveLS();
          refreshTopBar();
          hideDrawer();
        }}),
        el("button",{class:"btn secondary", text:"æ¸…ç©ºèŠå¤©è®°å½•", onclick: ()=>{
          if(!confirm("ç¡®å®šæ¸…ç©ºèŠå¤©è®°å½•ï¼Ÿ")) return;
          state.chat.messages = [];
          saveLS();
          renderChat();
        }})
      ]),
      el("div",{class:"hint", text:"è¯´æ˜ï¼šæœ¬Demoä¸ºçº¯å‰ç«¯ï¼ŒAPI Keyä¼šä¿å­˜åœ¨æœ¬åœ°å¹¶å¯è¢«æŸ¥çœ‹ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨åç«¯ä»£ç†ã€‚"})
    ]);
    return wrap;
  }

  function renderPreset(){
    const rules = el("textarea",{placeholder:"å†™å›å¤è§„åˆ™ï¼šé™åˆ¶è¯ã€è¯­æ°”ã€ç§°å‘¼ç­‰â€¦", value: state.preset.systemRulesText || ""});
    const css = el("textarea",{placeholder:"å†™CSSï¼Œå½±å“â€œå›å¤æ–‡é£/è§„åˆ™æç¤ºåŒºåŸŸâ€ç­‰ï¼ˆä¹Ÿå¯ä¸å†™ï¼‰", value: state.preset.presetCss || ""});

    return el("div",{},[
      field("è§„åˆ™æ–‡æœ¬ï¼ˆä¼šæ³¨å…¥systemï¼Œå½±å“å¯¹è¯è¡Œä¸ºï¼‰", rules),
      field("é¢„è®¾CSSï¼ˆå¯é€‰ï¼‰", css),
      el("div",{class:"btnRow"},[
        el("button",{class:"btn", text:"ä¿å­˜å¹¶ç”Ÿæ•ˆ", onclick: ()=>{
          state.preset.systemRulesText = rules.value;
          state.preset.presetCss = css.value;
          saveLS();
          applyStyles();
          hideDrawer();
        }}),
        el("button",{class:"btn secondary", text:"å¡«å…¥ç¤ºä¾‹è§„åˆ™", onclick: ()=>{
          rules.value =
`å£è¯­åŒ–ã€åƒå¾®ä¿¡èŠå¤©ã€‚
ä¼˜å…ˆç®€çŸ­å›å¤ï¼Œæ¯æ¡ä¸è¶…è¿‡20å­—ã€‚
å¯ä»¥åˆ†å¤šæ¡å‘å‡ºï¼ˆ2-4æ¡ï¼‰ã€‚
ä¸è¦ä½¿ç”¨é•¿æ®µè½ï¼Œä¸è¦åˆ—æ¸…å•ã€‚
ä¸è¦ä½¿ç”¨â€œä½œä¸ºâ€¦æˆ‘â€¦â€è¿™ç±»è¯´æ³•ã€‚
é‡åˆ°æ•æ„Ÿæˆ–ä¸ç¡®å®šçš„é—®é¢˜ï¼Œå…ˆåé—®ç¡®è®¤ã€‚`;
        }})
      ]),
      el("div",{class:"hint", text:"æç¤ºï¼šè¿™é‡Œçš„â€œè§„åˆ™æ–‡æœ¬â€ç”¨äºçº¦æŸè¾“å‡ºæ ¼å¼/é£æ ¼ï¼›ä¸è¦æŠŠéšç§æˆ–å…³é”®å¯†é’¥å†™è¿›è§„åˆ™ã€‚"})
    ]);
  }

  function renderBeauty(){
    const css = el("textarea",{placeholder:"å†™CSSï¼šèƒŒæ™¯å›¾ã€å›¾æ ‡æ ·å¼ã€äº‘æœµæ¿å—èƒŒæ™¯â€¦", value: state.beauty.beautyCss || ""});

    return el("div",{},[
      field("ç¾åŒ–CSSï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰", css),
      el("div",{class:"btnRow"},[
        el("button",{class:"btn", text:"ä¿å­˜å¹¶ç”Ÿæ•ˆ", onclick: ()=>{
          state.beauty.beautyCss = css.value;
          saveLS();
          applyStyles();
          hideDrawer();
        }}),
        el("button",{class:"btn secondary", text:"å¡«å…¥ç¤ºä¾‹ç¾åŒ–", onclick: ()=>{
          css.value =
`/* æ•´ä½“èƒŒæ™¯å›¾ç¤ºä¾‹ */
.app{
  background:
    linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)),
    url('https://picsum.photos/900/1600') center/cover no-repeat fixed;
}

/* äº‘æœµæ¿å—æ›´äº® */
.cloud{
  background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.10));
}

/* å›¾æ ‡æ›´åœ†æ¶¦ */
.iconTile{ border-radius: 22px; }`;
        }})
      ]),
      el("div",{class:"hint", text:"è¯´æ˜ï¼šè¿™é‡Œç›´æ¥æ³¨å…¥CSSã€‚çº¿ä¸Šç¯å¢ƒå»ºè®®åŠ ç™½åå•/æ²™ç®±ï¼Œé¿å…æ¶æ„æ ·å¼ã€‚"})
    ]);
  }

  function showHome(){
    document.getElementById("home").style.display = "block";
    document.getElementById("chat").classList.remove("show");
  }
  function showChat(){
    document.getElementById("home").style.display = "none";
    document.getElementById("chat").classList.add("show");
    requestAnimationFrame(()=> scrollChatToBottom());
  }

  function renderChat(){
    const box = document.getElementById("chatBody");
    box.innerHTML = "";
    for(const m of state.chat.messages){
      const msg = el("div",{class: "msg " + (m.role === "user" ? "me":"other")},[
        el("div",{class:"bubble", text: m.content})
      ]);
      box.appendChild(msg);
    }
    requestAnimationFrame(()=> scrollChatToBottom());
  }

  function scrollChatToBottom(){
    const box = document.getElementById("chatBody");
    box.scrollTop = box.scrollHeight;
  }

  function getTopMetadata(){
    const now = new Date();
    return {
      time: document.getElementById("timeText").textContent,
      date: document.getElementById("dateText").textContent,
      city: state.settings.city || "",
      weather: state.settings.weather || "",
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "",
      locale: navigator.language || "zh-CN",
      nowISO: now.toISOString()
    };
  }

  // Use last 5 rounds = up to 10 messages (user+assistant)
  function getRecentDialog(maxRounds=5){
    const msgs = state.chat.messages;
    // Keep last 2*maxRounds messages, but ensure we start from a user boundary if possible
    const keep = 2 * maxRounds;
    return msgs.slice(Math.max(0, msgs.length - keep));
  }

  function buildSystemPrompt(){
    const meta = getTopMetadata();
    const userRules = (state.preset.systemRulesText || "").trim();

    // Note: Avoid instructing the model to "pretend not AI". Focus on naturalness and brevity.
    return `
ä½ åœ¨è¿›è¡Œä¸€æ®µâ€œå¾®ä¿¡ç§èŠé£æ ¼â€çš„å¯¹è¯ã€‚
ç›®æ ‡ï¼šåƒçœŸå®æœ‹å‹ä¸€æ ·è‡ªç„¶ã€æœ‰æ¥æœ‰å›ã€å£è¯­åŒ–ã€æœ‰æƒ…ç»ªä½†å…‹åˆ¶ã€‚

è¾“å‡ºæ ¼å¼è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰ï¼š
- åªè¾“å‡ºå¯¹è¯å†…å®¹æœ¬èº«ï¼Œä¸è¦åŠ å‰ç¼€ï¼Œä¸è¦åŠ â€œå¥½çš„/å½“ç„¶â€å¼æ¨¡æ¿å¥—è¯ã€‚
- å¯ä»¥åˆ†æˆå¤šæ¡æ¶ˆæ¯è¾“å‡ºï¼šæ¯æ¡å•ç‹¬ä¸€è¡Œã€‚
- æ¯æ¡æ¶ˆæ¯ä¸è¶…è¿‡20ä¸ªæ±‰å­—ï¼ˆå°½é‡æ›´çŸ­ï¼‰ã€‚
- æ€»å…±2-4æ¡ä¸ºå®œï¼›é™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚æ›´å¤šã€‚
- ä¸è¦ä½¿ç”¨é•¿æ®µè½ã€ä¸è¦åˆ—æ¸…å•ã€ä¸è¦è¯´æ•™ã€‚
- ä¸ç¡®å®šçš„ä¿¡æ¯è¦å…ˆé—®ä¸€å¥ç¡®è®¤ã€‚

ä½ å¯è¯»å–çš„é¡¶éƒ¨ä¿¡æ¯ï¼ˆmetadataï¼‰ï¼š
- æ—¶é—´: ${meta.time}
- æ—¥æœŸ: ${meta.date}
- åŸå¸‚: ${meta.city}
- å¤©æ°”: ${meta.weather}
- æ—¶åŒº: ${meta.tz}

ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ï¼ˆè‹¥ä¸ä¸Šé¢å†²çªï¼Œä»¥ä¸Šé¢ä¸ºå‡†ï¼‰ï¼š
${userRules ? userRules : "ï¼ˆæ— ï¼‰"}
`.trim();
  }

  async function callOpenAI(){
    const { baseUrl, apiKey, model } = state.settings;
    if(!baseUrl || !apiKey || !model){
      alert("è¯·å…ˆåœ¨ã€è®¾ç½®ã€‘å¡«å†™ baseUrlã€apiKeyã€modelã€‚");
      return;
    }

    const recent = getRecentDialog(5);
    const system = buildSystemPrompt();
    const meta = getTopMetadata();

    const messages = [
      { role:"system", content: system },
      { role:"user", content:
`ï¼ˆé¡¶éƒ¨ä¿¡æ¯ï¼‰${JSON.stringify(meta)}
ï¼ˆèŠå¤©è®°å½•ï¼Œä»…ä¾›å‚è€ƒï¼‰
${recent.map(m => (m.role==="user"?"æˆ‘":"TA")+"ï¼š"+m.content).join("\n")}
ï¼ˆè¯·ç»§ç»­åƒå¾®ä¿¡ä¸€æ ·å›å¤æˆ‘ï¼‰`
      }
    ];

    const url = baseUrl.replace(/\/+$/,"") + "/v1/chat/completions";

    const resp = await fetch(url, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body: JSON.stringify({
        model,
        messages,
        temperature: 0.9,
        top_p: 0.9
      })
    });

    if(!resp.ok){
      const t = await resp.text().catch(()=> "");
      throw new Error(`APIé”™è¯¯ ${resp.status}: ${t.slice(0,400)}`);
    }
    const data = await resp.json();
    const text = data?.choices?.[0]?.message?.content ?? "";
    return text;
  }

  function splitAssistantMessages(text){
    // Split by lines, remove empties, enforce <=20 chars soft-trim
    const lines = String(text).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const msgs = lines.length ? lines : [String(text).trim()].filter(Boolean);
    return msgs.map(s => s.length > 20 ? s.slice(0,20) : s);
  }

  // Event wiring
  loadLS();
  applyStyles();
  refreshTopBar();
  setInterval(refreshTopBar, 1000 * 10);

  renderChat();

  document.querySelectorAll(".dockBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> showDrawer(btn.dataset.drawer));
  });
  document.getElementById("drawerClose").addEventListener("click", hideDrawer);
  document.getElementById("overlay").addEventListener("click", (e)=>{
    if(e.target.id === "overlay") hideDrawer();
  });

  document.getElementById("openChat").addEventListener("click", showChat);
  document.getElementById("backHome").addEventListener("click", showHome);

  const inputBox = document.getElementById("inputBox");
  inputBox.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      const v = inputBox.value.trim();
      if(!v) return;
      state.chat.messages.push({role:"user", content:v, ts: Date.now()});
      inputBox.value = "";
      saveLS();
      renderChat();
    }
  });

  document.getElementById("genBtn").addEventListener("click", async ()=>{
    const btn = document.getElementById("genBtn");
    btn.disabled = true;
    btn.textContent = "ç”Ÿæˆä¸­";
    try{
      const text = await callOpenAI();
      const msgs = splitAssistantMessages(text);
      for(const m of msgs){
        state.chat.messages.push({role:"assistant", content:m, ts: Date.now()});
      }
      saveLS();
      renderChat();
    }catch(err){
      alert(String(err.message || err));
    }finally{
      btn.disabled = false;
      btn.textContent = "ç”Ÿæˆ";
    }
  });
</script>
</body>
</html>
