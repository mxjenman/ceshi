<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI OS Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style id="custom-styles">
        /* 动态美化 CSS 将注入此处 */
    </style>
    <style>
        body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 24px; }
        .cloud-bg { background: linear-gradient(135deg, #e0f2fe 0%, #ffffff 100%); border-radius: 30px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .chat-dot { width: 12px; height: 12px; border-radius: 50%; background: #10b981; position: absolute; top: -2px; right: -2px; border: 2px solid white; }
        .hidden { display: none; }
        .wechat-input { border-top: 1px solid #ddd; background: #f7f7f7; }
        .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 8px; margin-bottom: 8px; font-size: 15px; position: relative; }
        .msg-self { background: #95ec69; align-self: flex-end; margin-left: auto; }
        .msg-ai { background: #fff; align-self: flex-start; }
    </style>
</head>
<body class="h-screen flex flex-col p-4">

    <header class="cloud-bg p-6 mb-8 text-slate-700 relative" id="header-section">
        <div class="flex justify-between items-start">
            <div>
                <h1 id="current-time" class="text-4xl font-light">12:00</h1>
                <p id="current-date" class="text-sm opacity-80">2026年2月27日 星期五</p>
            </div>
            <div class="text-right cursor-pointer" onclick="toggleSettings('weather-config')">
                <p id="display-city" class="font-bold text-lg">北京</p>
                <p id="display-weather" class="text-sm">晴 25°C</p>
            </div>
        </div>
    </header>

    <main class="flex-grow grid grid-cols-4 gap-6 content-start">
        <div class="flex flex-col items-center gap-2 cursor-pointer" onclick="openChat()">
            <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg relative">
                <i class="fab fa-weixin"></i>
                <div class="chat-dot"></div>
            </div>
            <span class="text-xs font-medium">私聊</span>
        </div>
    </main>

    <footer class="flex justify-around items-center py-4 glass-card mt-auto">
        <button onclick="toggleSettings('settings-panel')" class="flex flex-col items-center gap-1">
            <i class="fas fa-cog text-xl text-slate-600"></i>
            <span class="text-[10px]">设置</span>
        </button>
        <button onclick="toggleSettings('style-panel')" class="flex flex-col items-center gap-1">
            <i class="fas fa-paint-brush text-xl text-slate-600"></i>
            <span class="text-[10px]">美化</span>
        </button>
        <button onclick="toggleSettings('preset-panel')" class="flex flex-col items-center gap-1">
            <i class="fas fa-scroll text-xl text-slate-600"></i>
            <span class="text-[10px]">预设</span>
        </button>
    </footer>

    <div id="chat-window" class="fixed inset-0 bg-[#ededed] z-50 flex flex-col hidden">
        <div class="p-4 bg-[#ededed] flex items-center border-b">
            <button onclick="closeChat()" class="mr-4 text-lg"><i class="fas fa-chevron-left"></i></button>
            <span class="font-bold" id="chat-title">AI 好友</span>
        </div>
        <div id="chat-history" class="flex-grow overflow-y-auto p-4 flex flex-col">
            </div>
        <div class="wechat-input p-3 flex flex-col gap-2">
            <div class="flex items-center gap-2">
                <input id="user-input" type="text" class="flex-grow p-2 rounded border-none outline-none" placeholder="输入消息...">
                <button onclick="sendUserMsg()" class="bg-green-600 text-white px-4 py-2 rounded">发送</button>
            </div>
            <button id="gen-btn" onclick="fetchAIResponse()" class="w-full bg-blue-500 text-white py-2 rounded font-bold">生成 AI 回复</button>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center hidden p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 overflow-y-auto max-h-[80vh]">
            <div id="settings-panel" class="hidden space-y-4">
                <h2 class="text-xl font-bold">API 设置</h2>
                <input id="base-url" type="text" placeholder="Base URL (https://...)" class="w-full border p-2 rounded">
                <input id="api-key" type="password" placeholder="API Key" class="w-full border p-2 rounded">
                <input id="model-name" type="text" placeholder="Model Name (如 gpt-3.5-turbo)" class="w-full border p-2 rounded">
                <button onclick="saveConfig()" class="w-full bg-black text-white py-2 rounded">保存设置</button>
            </div>

            <div id="style-panel" class="hidden space-y-4">
                <h2 class="text-xl font-bold">美化 (CSS)</h2>
                <textarea id="custom-css" rows="6" class="w-full border p-2 rounded text-xs" placeholder="例如: #header-section { background: pink; }"></textarea>
                <button onclick="applyStyle()" class="w-full bg-black text-white py-2 rounded">应用样式</button>
            </div>

            <div id="preset-panel" class="hidden space-y-4">
                <h2 class="text-xl font-bold">回复预设 (System Prompt)</h2>
                <textarea id="system-prompt" rows="6" class="w-full border p-2 rounded text-xs" placeholder="定义AI的人设、说话风格..."></textarea>
                <button onclick="saveConfig()" class="w-full bg-black text-white py-2 rounded">保存预设</button>
            </div>

            <div id="weather-config" class="hidden space-y-4">
                <h2 class="text-xl font-bold">环境设置</h2>
                <input id="city-input" type="text" placeholder="所在城市" class="w-full border p-2 rounded">
                <input id="weather-input" type="text" placeholder="当前天气" class="w-full border p-2 rounded">
                <button onclick="saveWeather()" class="w-full bg-black text-white py-2 rounded">确认</button>
            </div>
            
            <button onclick="closeModals()" class="mt-4 w-full text-gray-400 text-sm">关闭</button>
        </div>
    </div>

    <script>
        // --- 初始化与数据存储 ---
        let config = JSON.parse(localStorage.getItem('ai_os_config')) || {
            baseUrl: '', apiKey: '', model: 'gpt-3.5-turbo',
            system: '你是一个真实的人类，现在我们在微信聊天。你的回复要简短，像真人一样自然，多用语气词，不要像AI。',
            city: '北京', weather: '晴 25°C', css: ''
        };

        let chatHistory = [];

        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            document.getElementById('base-url').value = config.baseUrl;
            document.getElementById('api-key').value = config.apiKey;
            document.getElementById('model-name').value = config.model;
            document.getElementById('system-prompt').value = config.system;
            document.getElementById('custom-css').value = config.css;
            document.getElementById('display-city').innerText = config.city;
            document.getElementById('display-weather').innerText = config.weather;
            applyStyle();
        }

        // --- 核心功能 ---
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').innerText = now.toLocaleDateString('zh-CN', options);
        }

        function toggleSettings(id) {
            document.getElementById('modal-container').classList.remove('hidden');
            ['settings-panel', 'style-panel', 'preset-panel', 'weather-config'].forEach(p => {
                document.getElementById(p).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModals() { document.getElementById('modal-container').classList.add('hidden'); }

        function saveConfig() {
            config.baseUrl = document.getElementById('base-url').value;
            config.apiKey = document.getElementById('api-key').value;
            config.model = document.getElementById('model-name').value;
            config.system = document.getElementById('system-prompt').value;
            localStorage.setItem('ai_os_config', JSON.stringify(config));
            closeModals();
        }

        function saveWeather() {
            config.city = document.getElementById('city-input').value || config.city;
            config.weather = document.getElementById('weather-input').value || config.weather;
            document.getElementById('display-city').innerText = config.city;
            document.getElementById('display-weather').innerText = config.weather;
            saveConfig();
        }

        function applyStyle() {
            config.css = document.getElementById('custom-css').value;
            document.getElementById('custom-styles').innerHTML = config.css;
            localStorage.setItem('ai_os_config', JSON.stringify(config));
        }

        // --- 聊天逻辑 ---
        function openChat() { document.getElementById('chat-window').classList.remove('hidden'); }
        function closeChat() { document.getElementById('chat-window').classList.add('hidden'); }

        function sendUserMsg() {
            const input = document.getElementById('user-input');
            if(!input.value.trim()) return;
            const text = input.value;
            renderMsg(text, 'self');
            chatHistory.push({ role: "user", content: text });
            input.value = '';
        }

        function renderMsg(text, type) {
            const container = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `msg-bubble ${type === 'self' ? 'msg-self' : 'msg-ai'}`;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function fetchAIResponse() {
            if(!config.apiKey) return alert('请先在设置中填写API Key');
            const btn = document.getElementById('gen-btn');
            btn.innerText = "对方正在输入...";
            btn.disabled = true;

            // 获取最近5轮对话
            const recentHistory = chatHistory.slice(-10); 
            const contextPrompt = `当前环境：${config.city}, ${config.weather}, 时间 ${new Date().toLocaleString()}。`;
            
            try {
                const response = await fetch(`${config.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: "system", content: config.system + " " + contextPrompt },
                            ...recentHistory
                        ],
                        temperature: 0.8
                    })
                });
                
                const data = await response.json();
                const aiMsg = data.choices[0].message.content;
                
                // 模拟真人：如果是长句，拆分成多条（按标点或长度）
                const messages = aiMsg.split(/[，。！？\n]/).filter(s => s.trim().length > 0);
                
                for(let m of messages) {
                    const subMsg = m.substring(0, 20); // 强制限制20字
                    renderMsg(subMsg, 'ai');
                    chatHistory.push({ role: "assistant", content: subMsg });
                    await new Promise(r => setTimeout(r, 800)); // 模拟输入延迟
                }
            } catch (e) {
                renderMsg("（连接API失败，请检查设置）", 'ai');
            } finally {
                btn.innerText = "生成 AI 回复";
                btn.disabled = false;
            }
        }

        init();
    </script>
</body>
</html>
