<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/cJ7TGpSf/IMG-3096.jpg">
    <link rel="icon" href="https://i.postimg.cc/cJ7TGpSf/IMG-3096.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Mobile OS">
    
    <title>AI Mobile OS - Plus Pro Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style id="custom-style">
        body { background: #f0f0f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 24px; }
        .app-icon { width: 60px; height: 60px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .app-icon:active { transform: scale(0.85); }
        .chat-msg-user { background: #95ec69; border-radius: 6px 0 6px 6px; }
        .chat-msg-ai { background: white; border-radius: 0 6px 6px 6px; }

        /* å°ç»„ä»¶æ ·å¼ */
        .widget-card{
            width:100%;
            border-radius:28px;
            padding:20px;
            background:linear-gradient(135deg,#ffffff,#f3f4f6);
            box-shadow:0 8px 20px rgba(0,0,0,0.08);
            position:relative;
            transition: all 0.3s ease;
        }
        .widget-avatar{
            width:60px;
            height:60px;
            border-radius:50%;
            object-fit:cover;
            border:3px solid white;
            box-shadow:0 4px 10px rgba(0,0,0,0.1);
        }
        .widget-emoji{
            font-size:14px;
            cursor:pointer;
        }
        .widget-text{
            position:absolute;
            bottom:15px;
            right:20px;
            font-size:12px;
            color:#555;
            cursor:pointer;
        }

        /* æˆªå›¾æ–°å¢å°ç»„ä»¶æ ·å¼ */
        .photo-widget {
            width: 160px;
            height: 160px;
            background: #fff;
            border: 2px solid #333;
            border-radius: 20px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .photo-area {
            flex: 1;
            background: #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            overflow: hidden;
            cursor: pointer;
        }
        .time-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }
        .time-labels {
            font-size: 11px;
            color: #333;
            font-weight: bold;
            line-height: 1.2;
        }
        .text-btn {
            border: 1.5px solid #333;
            border-radius: 20px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
        }

        /* æ¡Œé¢å¯¹è¯é¢„è§ˆæ ·å¼ */
        .preview-chat-container {
            width: 100%;
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .preview-header {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 280px;
        }
        .preview-role {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .role-tag {
            border: 1px solid #333;
            border-radius: 15px;
            padding: 1px 12px;
            font-style: italic;
            font-size: 10px;
            cursor: pointer;
        }
        .role-avatar-circle {
            width: 50px;
            height: 50px;
            background: #555;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 10px;
            cursor: pointer;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .preview-bubble-box {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .p-bubble {
            max-width: 80%;
            padding: 6px 12px;
            font-size: 11px;
            position: relative;
            cursor: pointer;
        }
        .p-bubble-left {
            align-self: flex-start;
            background: white;
            border: 1.5px solid #333;
            border-radius: 15px 15px 15px 0;
        }
        .p-bubble-right {
            align-self: flex-end;
            background: black;
            color: white;
            border-radius: 15px 15px 0 15px;
        }
        .status-label {
            position: absolute;
            font-size: 8px;
            bottom: -12px;
            color: #888;
            cursor: pointer;
        }

        /* è®ºå›ä¸“æœ‰æ ·å¼ */
        .tweet-card { border-bottom: 1px solid #eff3f4; padding: 12px 16px; background: white; }
        .tweet-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .fab-btn { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 28px; background: #000000; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 24px; z-index: 60; cursor: pointer; transition: transform 0.1s; }
        .fab-btn:active { transform: scale(0.9); }
        .btn-disabled { background-color: #cccccc !important; cursor: not-allowed !important; opacity: 0.6; }
        .action-icon { width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 4px; opacity: 0.6; }
        .nav-sync-icon { width: 24px; height: 24px; object-fit: contain; }
        .back-icon { font-size: 20px; font-weight: 400; color: #000000; line-height: 1; display: flex; align-items: center; justify-content: center; }

        /* è®ºå›ä¸»é¡µæ ·å¼æ‰©å±• */
        .profile-banner { width: 100%; height: 120px; background: #cfd9de; cursor: pointer; object-fit: cover; }
        .profile-avatar-main { width: 80px; height: 80px; border-radius: 20px; border: 4px solid white; margin-top: -40px; margin-left: 15px; position: relative; cursor: pointer; object-fit: cover; background: white; }
        .tab-active { border-bottom: 4px solid #1d9bf0; color: #000; font-weight: bold; }
        
        /* è¿›åœºåŠ¨ç”» */
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¾®ä¿¡ä¸“æœ‰æ ·å¼ */
        .wechat-nav-active { color: #07c160 !important; }
        .moments-header { height: 200px; background: #333; position: relative; width: 100%; }
        .moments-avatar { width: 70px; height: 70px; border-radius: 8px; border: 2px solid white; position: absolute; right: 15px; bottom: -15px; }
        .moments-name { color: white; font-weight: bold; position: absolute; right: 100px; bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        /* å¾®ä¿¡â€œæˆ‘â€é¡µé¢è¿˜åŸæ ·å¼ */
        .wx-me-header { padding: 27px 24px 20px 24px; background: white; display: flex; flex-direction: column; align-items: flex-start; }
        .wx-me-avatar-rect { width: 82px; height: 82px; border-radius: 50%; object-fit: cover; background: #f0f0f0; margin-bottom: 16px; cursor: pointer; }
        .wx-status-tag { display: inline-flex; align-items: center; border: 1px solid #e8e8e8; border-radius: 20px; padding: 2px 10px; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; background: #fdfdfd; }
        .wx-status-dot { width: 6px; height: 6px; background: #07c160; border-radius: 50%; margin-right: 6px; }
        #wx-me-name { font-size: 22px; font-weight: 600; color: #303030; cursor: pointer; }
        #wx-me-id { color: #9ca3af; font-size: 15px; font-weight: 300; margin-top: 4px; cursor: pointer; }
        .wx-menu-item { background: white; padding: 18px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid #f2f2f2; cursor: pointer; transition: background 0.2s; }
        .page-layer { position: fixed; inset: 0; background: #f0f0f0; z-index: 100; transition: transform 0.3s ease; }
        .slide-hidden { transform: translateX(100%); }
        .wx-divider-thin { height: 0.5px; background-color: #f2f2f2; width: 100%; }
    </style>
</head>
<body class="h-screen overflow-x-hidden flex flex-col">

    <div id="home-screen" class="flex-1 p-6 flex flex-col items-center overflow-y-auto pb-24">
        <div class="widget-card mb-8 mt-4">
            <div class="flex items-start gap-10">
                <div class="flex flex-col items-center gap-1">
                    <span class="widget-emoji" onclick="editEmoji('left')">(â¸â¸à¹‘  Ì« à¹‘â¸â¸)</span>
                    <img id="avatar-left" class="widget-avatar" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" onclick="changeAvatar('left')">
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="widget-emoji" onclick="editEmoji('right')">(Ë¶âƒ Ï‰ âƒË¶)</span>
                    <img id="avatar-right" class="widget-avatar" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" onclick="changeAvatar('right')">
                </div>
            </div>
            <div id="widget-text" class="widget-text" onclick="editWidgetText()">æˆ‘ä¸æƒ³éš”ç€å±å¹•å’Œä½ è¯´è¯</div>
        </div>

        <div class="w-full flex justify-between items-start mb-8 px-2">
            <div class="photo-widget">
                <div class="photo-area" id="main-photo" onclick="editPhoto('main-photo')">ç…§ç‰‡</div>
                <div class="time-box">
                    <div class="time-labels" onclick="alert('æ—¶é—´æ¯ç§’è‡ªåŠ¨åŒæ­¥')">
                        <div id="wd-heart">â™¥ <span id="cur-date">0-0</span></div>
                        <div id="wd-star">â˜… <span id="cur-time">00:00</span></div>
                    </div>
                    <div class="text-btn" id="wd-custom-btn" onclick="editTextContent('wd-custom-btn')">æ–‡æœ¬</div>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex flex-col items-center gap-1">
                    <div class="app-icon bg-gray-600" onclick="openBlankPage('å ä½1')"></div>
                </div>
                <div class="flex flex-col items-center gap-1" onclick="openChat()">
                    <div class="app-icon overflow-hidden p-0">
                        <img src="https://i.postimg.cc/fycLsZLY/quality-restoration-20260228193355205.png" class="w-full h-full object-cover rounded-[15px]">
                    </div>
                    <span class="text-[10px] text-gray-600 font-bold">å¾®ä¿¡</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-6 w-full px-4 mb-8">
            <div class="flex flex-col items-center gap-1">
                <div class="app-icon bg-gray-600" onclick="openBlankPage('å ä½1')"></div>
            </div>
            <div class="flex flex-col items-center gap-1" onclick="openBlankPage('ä¸–ç•Œä¹¦')">
                <div class="app-icon bg-gray-800 flex items-center justify-center text-white text-xs">ä¸–ç•Œä¹¦</div>
                <span class="text-[10px] text-gray-600 font-bold">ä¸–ç•Œä¹¦</span>
            </div>
            <div class="flex flex-col items-center gap-1" onclick="openForum()">
                <div class="app-icon overflow-hidden p-0">
                    <img src="https://i.postimg.cc/ZnjMz01G/quality-restoration-20260228202408361.png" class="w-full h-full object-cover rounded-[15px]">
                </div>
                <span class="text-[10px] text-gray-600 font-bold">è®ºå›</span>
            </div>
        </div>

        <div class="preview-chat-container">
            <div class="preview-header">
                <div class="preview-role">
                    <div class="role-tag" id="tag-char" onclick="editTextContent('tag-char')">char</div>
                    <div class="role-avatar-circle" id="av-char" onclick="editPhoto('av-char')">å¤´åƒ</div>
                </div>
                <div class="preview-role">
                    <div class="role-tag" id="tag-user" onclick="editTextContent('tag-user')">user</div>
                    <div class="role-avatar-circle" id="av-user" onclick="editPhoto('av-user')">å¤´åƒ</div>
                </div>
            </div>
            <div class="preview-bubble-box px-4">
                <div class="p-bubble p-bubble-left" onclick="editTextContent(this)">
                    æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬
                    <span class="status-label left-0" style="left:2px" onclick="editTextContent(this);event.stopPropagation()">å·²è¯»</span>
                </div>
                <div class="p-bubble p-bubble-right" onclick="editTextContent(this)">
                    æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬æ–‡æœ¬
                    <span class="status-label right-0" style="right:2px; text-align:right" onclick="editTextContent(this);event.stopPropagation()">æœªè¯»</span>
                </div>
            </div>
        </div>

        <div class="fixed bottom-4 glass-card w-[90%] py-4 px-8 flex justify-between items-center z-40">
            <button onclick="openModal('settings')" class="flex flex-col items-center">
                <span class="text-xl">âš™ï¸</span><span class="text-[10px]">è®¾ç½®</span>
            </button>
            <button onclick="openModal('beauty')" class="flex flex-col items-center">
                <span class="text-xl">ğŸ¨</span><span class="text-[10px]">ç¾åŒ–</span>
            </button>
            <button onclick="openModal('presets')" class="flex flex-col items-center">
                <span class="text-xl">ğŸ“‘</span><span class="text-[10px]">é¢„è®¾</span>
            </button>
        </div>
    </div>

    <div id="chat-screen" class="fixed inset-0 bg-[#ededed] hidden flex flex-col z-50">
        <div class="h-12 bg-[#ededed] flex items-center px-4 border-b border-gray-200">
            <button onclick="closeChat()" class="back-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div id="wechat-title" class="flex-1 text-center font-bold text-[17px]">å¾®ä¿¡</div>
            <div class="w-6 text-2xl flex justify-center">ï¼‹</div>
        </div>
        <div id="wechat-content" class="flex-1 overflow-y-auto">
            <div id="wechat-tab-messages">
                <div id="chat-flow" class="p-4 space-y-4 min-h-[400px]">
                    <div class="text-center text-xs text-gray-400 my-4">å¼€å§‹ä¸ AI å¥½å‹èŠå¤©å§</div>
                </div>
                <div class="p-3 bg-[#f7f7f7] border-t flex flex-col gap-2 sticky bottom-0">
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" class="flex-1 border-none rounded bg-white px-3 py-2 outline-none" placeholder="è¾“å…¥æ¶ˆæ¯...">
                        <button onclick="sendUserMsg()" class="bg-green-600 text-white px-4 py-2 rounded">å‘é€</button>
                    </div>
                    <button onclick="triggerAI()" id="gen-btn" class="w-full bg-blue-500 text-white py-1 rounded text-sm">ç‚¹å‡»ç”Ÿæˆå¯¹æ–¹å›å¤</button>
                </div>
            </div>
            <div id="wechat-tab-moments" class="hidden bg-white min-h-full">
                <div class="moments-header">
                    <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800" class="w-full h-full object-cover">
                    <span class="moments-name" id="wx-moments-name">User</span>
                    <img id="wx-moments-avatar" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" class="moments-avatar">
                </div>
                <div class="mt-10 p-4 space-y-8">
                    <div class="flex gap-3 border-b pb-6">
                        <img src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" class="w-10 h-10 rounded">
                        <div class="flex-1">
                            <div class="text-[#576b95] font-bold">AI åŠ©æ‰‹</div>
                            <div class="text-black mt-1">ä»Šå¤©çš„å¤©æ°”çœŸä¸é”™ï¼</div>
                            <div class="text-xs text-gray-400 mt-2">1å°æ—¶å‰</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="wechat-tab-me" class="hidden bg-white min-h-full">
                <div class="wx-me-header">
                    <img id="wx-me-avatar" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" class="wx-me-avatar-rect" onclick="editProfilePart('avatar')">
                    <div class="flex items-center gap-3">
                        <span id="wx-me-name" onclick="editProfilePart('name')">{{user}}</span>
                        <div class="wx-status-tag" onclick="editStatus()">
                            <span class="wx-status-dot"></span>
                            <span id="wx-me-status">çŠ¶æ€</span>
                        </div>
                    </div>
                    <div id="wx-me-id" onclick="editProfilePart('handle')">@user_ai</div>
                </div>
                <div class="wx-divider-thin"></div>
                <div class="bg-white">
                    <div class="wx-menu-item" onclick="openMePage('é’±åŒ…')"><span>é’±åŒ…</span></div>
                    <div class="wx-divider-thin"></div>
                    <div class="wx-menu-item" onclick="openMePage('è®¾ç½®')"><span>è®¾ç½®</span></div>
                </div>
            </div>
        </div>
        <div class="h-14 bg-[#f7f7f7] border-t flex items-center justify-around text-gray-500 text-[12px]">
            <div onclick="switchWechatTab('messages')" id="wx-nav-messages" class="flex flex-col items-center wechat-nav-active"><span>å¾®ä¿¡</span></div>
            <div onclick="switchWechatTab('moments')" id="wx-nav-moments" class="flex flex-col items-center"><span>æœ‹å‹åœˆ</span></div>
            <div onclick="switchWechatTab('me')" id="wx-nav-me" class="flex flex-col items-center"><span>æˆ‘</span></div>
        </div>
    </div>

    <div id="forum-screen" class="fixed inset-0 bg-white hidden flex flex-col z-50 overflow-hidden">
        <div id="forum-content-container" class="flex-1 overflow-y-auto pb-16">
            <div id="view-square">
                <div class="h-14 bg-white/80 backdrop-blur-md flex items-center px-4 border-b sticky top-0 z-10">
                    <button onclick="closeForum()" class="back-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="flex-1 text-center font-bold text-[16px]">æ¨æ–‡</div>
                    <button onclick="generateAIPosts()"><img src="https://i.postimg.cc/BntTBs0P/IMG-3094.png" class="nav-sync-icon"></button>
                </div>
                <div id="forum-feed"><div id="empty-hint" class="p-10 text-center text-gray-400">æš‚æ— åŠ¨æ€</div></div>
            </div>
            <div id="view-profile" class="hidden">
                <div class="relative">
                    <img id="profile-bg" class="profile-banner" src="https://images.unsplash.com/photo-1557683316-973673baf926?w=800" onclick="editProfilePart('bg')">
                    <img id="profile-avatar" class="profile-avatar-main" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" onclick="editProfilePart('avatar')">
                </div>
                <div class="px-4 mt-2">
                    <h2 id="profile-name" class="text-xl font-black">{{user}}</h2>
                    <p id="profile-handle" class="text-gray-500 text-sm">@user_ai</p>
                    <p id="profile-bio" class="mt-3 text-[15px]">æ¢ç´¢AI OSçš„æ— é™å¯èƒ½ã€‚</p>
                </div>
                <div id="profile-posts-feed"></div>
            </div>
        </div>
        <div class="h-16 border-t flex items-center justify-around bg-white absolute bottom-0 w-full z-20">
            <button onclick="switchForumTab('square')" id="tab-square" class="text-blue-500"><span class="text-xs font-bold">é¦–é¡µ</span></button>
            <button onclick="switchForumTab('profile')" id="tab-profile" class="text-gray-400"><span class="text-xs font-bold">æˆ‘</span></button>
        </div>
        <div class="fab-btn" onclick="openCompose()">+</div>
    </div>

    <div id="me-detail-page" class="page-layer slide-hidden flex flex-col">
        <div class="h-12 bg-white flex items-center px-4 border-b">
            <button onclick="closeMePage()" class="back-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div id="me-detail-title" class="flex-1 text-center font-bold"></div>
            <div class="w-6"></div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center text-gray-400 italic p-10 text-center">
            <div class="text-4xl mb-4">ğŸ§±</div>
            è¿™é‡Œæš‚æ—¶ç©ºç©ºå¦‚ä¹Ÿ...<br>è¿™åªæ˜¯ä¸€ä¸ªå ä½é¡µé¢ã€‚
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl w-full max-h-[80vh] overflow-y-auto p-6 shadow-2xl">
            <div id="modal-content"></div>
            <button onclick="closeModal()" class="mt-6 w-full py-3 bg-gray-100 rounded-xl font-bold">ä¿å­˜å¹¶è¿”å›</button>
        </div>
    </div>

    <div id="compose-screen" class="fixed inset-0 bg-white hidden flex flex-col z-[70]">
        <div class="h-14 flex items-center justify-between px-4">
            <button onclick="closeCompose()">å–æ¶ˆ</button>
            <button id="post-submit-btn" onclick="submitPost()" class="bg-black text-white px-4 py-1.5 rounded-full font-bold">å‘å¸ƒ</button>
        </div>
        <div class="p-4 flex gap-3">
            <img id="compose-avatar-sync" src="" class="w-10 h-10 rounded-full">
            <textarea id="post-text" class="flex-1 text-lg outline-none resize-none" placeholder="åˆ†äº«æ–°é²œäº‹..."></textarea>
        </div>
    </div>

<script>
let config = {
    baseUrl: 'https://api.openai.com/v1',
    apiKey: '',
    model: 'gpt-4o-mini',
    systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªçœŸå®çš„å¾®ä¿¡å¥½å‹ï¼Œå›å¤æç®€ï¼Œæ§åˆ¶åœ¨20å­—å†…ã€‚',
    customCss: ''
};

let userProfile = {
    name: "{{user}}",
    handle: "@user_ai",
    avatar: "https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg",
    bio: "æ¢ç´¢AI OSçš„æ— é™å¯èƒ½ã€‚",
    status: "çŠ¶æ€"
};

let chatHistory = [];

// å®æ—¶æ›´æ–°æ—¶é’Ÿ
function updateClock() {
    const now = new Date();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const hour = now.getHours().toString().padStart(2, '0');
    const min = now.getMinutes().toString().padStart(2, '0');
    
    const dateEl = document.getElementById('cur-date');
    const timeEl = document.getElementById('cur-time');
    
    if(dateEl) dateEl.innerText = `${month}-${day}`;
    if(timeEl) timeEl.innerText = `${hour}:${min}`;
}
setInterval(updateClock, 1000);

// é€šç”¨æ–‡æœ¬ç¼–è¾‘
function editTextContent(idOrEl) {
    const el = (typeof idOrEl === 'string') ? document.getElementById(idOrEl) : idOrEl;
    // å¤„ç†å¸¦çŠ¶æ€æ ‡ç­¾çš„æƒ…å†µï¼Œåªæ‹¿æ–‡æœ¬èŠ‚ç‚¹
    const oldText = el.childNodes[0].textContent.trim();
    const res = prompt("ç¼–è¾‘å†…å®¹", oldText);
    if(res !== null) {
        el.childNodes[0].textContent = res + " ";
    }
}

// é€šç”¨ç…§ç‰‡/å¤´åƒç¼–è¾‘
function editPhoto(id) {
    const el = document.getElementById(id);
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'image/*';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            if(el.tagName === 'IMG') {
                el.src = ev.target.result;
            } else {
                el.innerHTML = `<img src="${ev.target.result}" class="w-full h-full object-cover">`;
            }
        };
        reader.readAsDataURL(e.target.files[0]);
    };
    input.click();
}

function openBlankPage(title) {
    document.getElementById('me-detail-title').innerText = title;
    document.getElementById('me-detail-page').classList.remove('slide-hidden');
}

function closeMePage() {
    document.getElementById('me-detail-page').classList.add('slide-hidden');
}

// --- åŸæœ‰é€»è¾‘ä¿ç•™ ---
function changeAvatar(side){
    const input=document.createElement('input');
    input.type='file'; input.accept='image/*';
    input.onchange=e=>{
        const reader=new FileReader();
        reader.onload=ev=>{ 
            document.getElementById(`avatar-${side}`).src=ev.target.result; 
            userProfile.avatar = ev.target.result;
            syncAvatarEverywhere();
        };
        reader.readAsDataURL(e.target.files[0]);
    };
    input.click();
}

function syncAvatarEverywhere() {
    const src = userProfile.avatar;
    ['wx-moments-avatar', 'wx-me-avatar', 'profile-avatar', 'compose-avatar-sync'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.src = src;
    });
}

function editEmoji(side){
    const el=document.querySelectorAll('.widget-emoji')[side==='left'?0:1];
    const result=prompt("ä¿®æ”¹é¢œæ–‡å­—",el.innerText);
    if(result) el.innerText=result;
}

function editWidgetText(){
    const el=document.getElementById('widget-text');
    const result=prompt("ä¿®æ”¹æ–‡æ¡ˆ",el.innerText);
    if(result) el.innerText=result;
}

function editStatus() {
    const res = prompt("è®¾ç½®çŠ¶æ€", userProfile.status);
    if(res) {
        userProfile.status = res;
        document.getElementById('wx-me-status').innerText = res;
    }
}

function switchWechatTab(tab) {
    ['messages', 'moments', 'me'].forEach(t => {
        document.getElementById(`wechat-tab-${t}`).classList.add('hidden');
        document.getElementById(`wx-nav-${t}`).classList.remove('wechat-nav-active');
    });
    document.getElementById(`wechat-tab-${tab}`).classList.remove('hidden');
    document.getElementById(`wx-nav-${tab}`).classList.add('wechat-nav-active');
}

function openChat(){ document.getElementById('chat-screen').classList.remove('hidden'); }
function closeChat(){ document.getElementById('chat-screen').classList.add('hidden'); }

function renderMsg(text,role){
    const container=document.getElementById('chat-flow');
    const div=document.createElement('div');
    div.className=`flex ${role==='user'?'justify-end':'justify-start'} animate-in`;
    div.innerHTML=`<div class="max-w-[80%] px-3 py-2 shadow-sm text-sm ${role==='user'?'chat-msg-user':'chat-msg-ai'}">${text}</div>`;
    container.appendChild(div);
    container.scrollTop=container.scrollHeight;
}

function sendUserMsg(){
    const input=document.getElementById('chat-input');
    if(!input.value)return;
    renderMsg(input.value,'user');
    chatHistory.push({role:'user',content:input.value});
    input.value='';
}

async function triggerAI(){
    if(!config.apiKey)return alert("è¯·é…ç½® API Key");
    const btn=document.getElementById('gen-btn');
    btn.innerText="å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
    try{
        const response=await fetch(`${config.baseUrl}/chat/completions`,{
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${config.apiKey}`},
            body:JSON.stringify({model:config.model,messages:[{role:'system',content:config.systemPrompt},...chatHistory.slice(-5)]})
        });
        const data=await response.json();
        const reply=data.choices[0].message.content;
        renderMsg(reply,'assistant');
        chatHistory.push({role:'assistant',content:reply});
    }catch(e){ renderMsg("å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®",'assistant'); }
    finally{ btn.innerText="ç‚¹å‡»ç”Ÿæˆå¯¹æ–¹å›å¤"; }
}

function openForum(){ document.getElementById('forum-screen').classList.remove('hidden'); }
function closeForum(){ document.getElementById('forum-screen').classList.add('hidden'); }
function switchForumTab(tab){
    const sq = document.getElementById('view-square');
    const pr = document.getElementById('view-profile');
    if(tab === 'square'){ sq.classList.remove('hidden'); pr.classList.add('hidden'); }
    else { sq.classList.add('hidden'); pr.classList.remove('hidden'); }
}

function openCompose(){ 
    document.getElementById('compose-screen').classList.remove('hidden'); 
    document.getElementById('compose-avatar-sync').src = userProfile.avatar;
}
function closeCompose(){ document.getElementById('compose-screen').classList.add('hidden'); }

function addPostToFeed(name, handle, text, time){
    const feed = document.getElementById('forum-feed');
    const div = document.createElement('div');
    div.className = "tweet-card flex gap-3 animate-in";
    div.innerHTML = `<img src="${userProfile.avatar}" class="tweet-avatar"><div><div class="flex gap-1"><span class="font-bold">${name}</span><span class="text-gray-500">${handle}</span></div><div class="mt-1">${text}</div></div>`;
    feed.prepend(div);
}

function submitPost(){
    const txt = document.getElementById('post-text').value;
    if(!txt) return;
    addPostToFeed(userProfile.name, userProfile.handle, txt, "ç°åœ¨");
    closeCompose();
    document.getElementById('post-text').value = "";
}

async function generateAIPosts(){
    if(!config.apiKey) return alert("åŒæ­¥å¹¿åœºéœ€è¦ API Key");
    const feed = document.getElementById('forum-feed');
    feed.innerHTML = '<div class="p-10 text-center animate-pulse">å¹¿åœºåŒæ­¥ä¸­...</div>';
    try {
        const response = await fetch(`${config.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}`},
            body: JSON.stringify({model: config.model, messages: [{role: 'system', content: 'ç”Ÿæˆ3æ¡æœ‰è¶£çš„ç¤¾äº¤åŠ¨æ€JSON: {"posts":[{"name":"ç”¨æˆ·","handle":"@id","text":"å†…å®¹"}]}'}], response_format: {type: "json_object"}})
        });
        const data = await response.json();
        const posts = JSON.parse(data.choices[0].message.content).posts;
        feed.innerHTML = "";
        posts.forEach(p => addPostToFeed(p.name, p.handle, p.text));
    } catch(e) { feed.innerHTML = "åŒæ­¥å¤±è´¥"; }
}

function openModal(type){
    const content=document.getElementById('modal-content');
    document.getElementById('modal-overlay').classList.remove('hidden');
    if(type==='settings'){
        content.innerHTML=`<h2 class="text-xl font-bold mb-4">API è®¾ç½®</h2><p class="text-xs mb-1">Base URL</p><input id="cfg-url" class="w-full border p-2 mb-3 rounded" value="${config.baseUrl}"><p class="text-xs mb-1">API Key</p><input id="cfg-key" type="password" class="w-full border p-2 mb-3 rounded" value="${config.apiKey}"><p class="text-xs mb-1">æ¨¡å‹</p><input id="cfg-model" class="w-full border p-2 mb-3 rounded" value="${config.model}">`;
    }else if(type==='beauty'){
        content.innerHTML=`<h2 class="text-xl font-bold mb-4">CSS ç¾åŒ–</h2><textarea id="cfg-css" class="w-full border p-2 h-40 font-mono text-sm">${config.customCss}</textarea>`;
    }else if(type==='presets'){
        content.innerHTML=`<h2 class="text-xl font-bold mb-4">AI é¢„è®¾</h2><textarea id="cfg-prompt" class="w-full border p-2 h-40 text-sm">${config.systemPrompt}</textarea>`;
    }
}

function closeModal(){
    if(document.getElementById('cfg-url')){
        config.baseUrl=document.getElementById('cfg-url').value;
        config.apiKey=document.getElementById('cfg-key').value;
        config.model=document.getElementById('cfg-model').value;
    }
    if(document.getElementById('cfg-css')){
        const css = document.getElementById('cfg-css').value;
        config.customCss = css;
        document.getElementById('custom-style').innerHTML += css;
    }
    if(document.getElementById('cfg-prompt')){
        config.systemPrompt=document.getElementById('cfg-prompt').value;
    }
    document.getElementById('modal-overlay').classList.add('hidden');
}

window.onload = () => {
    updateClock();
    syncAvatarEverywhere();
};
</script>
</body>
</html>
