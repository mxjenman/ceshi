<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mobile OS</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style id="custom-theme">
        /* é»˜è®¤æ ·å¼ - å¯é€šè¿‡â€œç¾åŒ–â€åŠŸèƒ½è¦†ç›– */
        :root {
            --bg-image: url('https://images.unsplash.com/photo-1557683316-973673baf926');
            --glass-bg: rgba(255, 255, 255, 0.7);
            --accent-color: #07C160; /* å¾®ä¿¡ç»¿ */
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-image) no-repeat center center fixed;
            background-size: cover;
            overflow: hidden;
        }

        /* é¡¶éƒ¨äº‘æœµæ¿å— */
        .top-panel {
            margin: 20px;
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            color: #333;
        }

        .time { font-size: 3rem; font-weight: 300; margin: 0; }
        .date { font-size: 1rem; opacity: 0.8; }
        .weather-info { margin-top: 10px; font-size: 0.9rem; }

        /* æ¡Œé¢å›¾æ ‡åŒºåŸŸ */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .icon-box {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 5px;
        }

        .app-label { color: white; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        /* å¼¹çª—ç•Œé¢ (è®¾ç½®/å¯¹è¯) */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #ededed;
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .modal-header {
            height: 50px;
            background: #f3f3f3;
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid #ddd;
            justify-content: space-between;
        }

        /* å¾®ä¿¡å¯¹è¯é£æ ¼ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .msg { max-width: 70%; margin-bottom: 15px; padding: 10px 14px; border-radius: 8px; font-size: 15px; line-height: 1.5; word-wrap: break-word; }
        .msg.user { align-self: flex-end; background: #95ec69; position: relative; }
        .msg.ai { align-self: flex-start; background: white; }

        .chat-input-area {
            background: #f7f7f7;
            padding: 10px;
            display: flex;
            align-items: center;
            border-top: 1px solid #ddd;
        }

        input[type="text"], textarea, select {
            width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;
        }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(15px);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            gap: 25px;
        }
        .dock-item { font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="top-panel" id="clock-panel">
            <div class="time" id="current-time">00:00</div>
            <div class="date" id="current-date">åŠ è½½ä¸­...</div>
            <div class="weather-info">
                <span id="display-city">åŒ—äº¬</span> Â· <span id="display-weather">æ™´ 25Â°C</span>
            </div>
        </div>

        <div class="app-grid">
            <div class="app-icon" onclick="openModal('chat-modal')">
                <div class="icon-box" style="background: #07C160; color: white;">ğŸ’¬</div>
                <div class="app-label">ç§èŠ</div>
            </div>
        </div>

        <div class="dock">
            <div class="dock-item" onclick="openModal('settings-modal')">âš™ï¸</div>
            <div class="dock-item" onclick="openModal('beauty-modal')">ğŸ¨</div>
            <div class="dock-item" onclick="openModal('preset-modal')">ğŸ“</div>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-header">
            <span onclick="closeModal('chat-modal')">ã€ˆ è¿”å›</span>
            <b id="chat-title">AI å¥½å‹</b>
            <span style="opacity:0">...</span>
        </div>
        <div id="chat-container"></div>
        <div class="chat-input-area">
            <input type="text" id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <button onclick="sendMsg()" style="margin-left:5px; background:var(--accent-color); color:white; border:none; padding:8px 15px; border-radius:5px;">å‘é€</button>
            <button onclick="generateAI()" style="margin-left:5px; background:#007AFF; color:white; border:none; padding:8px 15px; border-radius:5px;">ç”Ÿæˆ</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-header">
            <span>API è®¾ç½®</span>
            <button onclick="saveSettings()">ä¿å­˜</button>
        </div>
        <div style="padding: 20px;">
            <label>API åŸºç¡€åœ°å€ (Base URL)</label>
            <input type="text" id="base-url" placeholder="https://api.openai.com/v1">
            <label>API å¯†é’¥ (API Key)</label>
            <input type="password" id="api-key" placeholder="sk-...">
            <label>æ¨¡å‹é€‰æ‹©</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="model-name" placeholder="gpt-3.5-turbo">
                <button onclick="fetchModels()" style="width:80px">æ‹‰å–</button>
            </div>
            <hr>
            <label>åŸå¸‚è®¾ç½®</label>
            <input type="text" id="set-city" value="åŒ—äº¬">
            <label>å¤©æ°”è®¾ç½®</label>
            <input type="text" id="set-weather" value="æ™´ 25Â°C">
            <button onclick="closeModal('settings-modal')" style="width:100%; margin-top:20px;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="preset-modal" class="modal">
        <div class="modal-header">
            <span>å›å¤é¢„è®¾ (System Prompt)</span>
            <button onclick="savePreset()">ä¿å­˜</button>
        </div>
        <div style="padding:20px;">
            <p style="font-size:12px; color:#666;">åœ¨è¿™é‡Œå®šä¹‰AIçš„æ€§æ ¼å’Œå›å¤è§„åˆ™ï¼š</p>
            <textarea id="system-prompt" rows="15" placeholder="ä½ ç°åœ¨æ˜¯ä¸€ä¸ªçœŸå®çš„äººç±»æœ‹å‹..."></textarea>
            <button onclick="closeModal('preset-modal')" style="width:100%; margin-top:10px;">è¿”å›</button>
        </div>
    </div>

    <div id="beauty-modal" class="modal">
        <div class="modal-header">
            <span>ç•Œé¢ç¾åŒ– (CSS)</span>
            <button onclick="saveBeauty()">åº”ç”¨</button>
        </div>
        <div style="padding:20px;">
            <textarea id="custom-css" rows="15" placeholder=":root { --bg-image: url('...'); }"></textarea>
            <button onclick="closeModal('beauty-modal')" style="width:100%; margin-top:10px;">è¿”å›</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let config = JSON.parse(localStorage.getItem('ai_config')) || {
            baseUrl: '', apiKey: '', model: 'gpt-3.5-turbo',
            city: 'åŒ—äº¬', weather: 'æ™´ 25Â°C',
            systemPrompt: `ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨å’Œæˆ‘è¿›è¡Œå¾®ä¿¡èŠå¤©çš„çœŸå®äººç±»æœ‹å‹ã€‚
å›å¤è§„èŒƒï¼š
1. è¯­è¨€æå…¶å£è¯­åŒ–ï¼Œå¤šç”¨â€œå“ˆâ€ã€â€œæ˜‚â€ã€â€œå˜›â€ç­‰è¯­æ°”è¯ã€‚
2. ç»å¯¹ä¸æ‰¿è®¤è‡ªå·±æ˜¯AIï¼Œä¸ä½¿ç”¨â€œä½œä¸ºAIæ¨¡å‹â€ç­‰å­—çœ¼ã€‚
3. æ¯æ¬¡å›å¤éå¸¸ç®€çŸ­ï¼Œä¸è¶…è¿‡20å­—ï¼Œç”šè‡³å¯ä»¥åªæœ‰å‡ ä¸ªå­—ã€‚
4. è¡¨ç°å‡ºæƒ…ç»ªæ³¢åŠ¨ï¼Œå¶å°”å‘ä¸ª[å¾®ç¬‘]æˆ–[æ‚è„¸]ï¼ˆæ–‡å­—æè¿°ï¼‰ã€‚
5. é€»è¾‘è¦åƒçœŸäººï¼Œå¦‚æœæˆ‘ä¸è¯´è¯æˆ–å‘åƒåœ¾ä¿¡æ¯ï¼Œä½ ä¼šåæ§½ã€‚`,
            customCss: ''
        };

        let chatHistory = [];

        // æ›´æ–°æ—¶é’Ÿ
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').innerText = now.toLocaleDateString('zh-CN', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // çª—å£ç®¡ç†
        function openModal(id) { 
            document.getElementById(id).style.display = 'flex'; 
            if(id === 'settings-modal') {
                document.getElementById('base-url').value = config.baseUrl;
                document.getElementById('api-key').value = config.apiKey;
                document.getElementById('model-name').value = config.model;
            }
            if(id === 'preset-modal') document.getElementById('system-prompt').value = config.systemPrompt;
            if(id === 'beauty-modal') document.getElementById('custom-css').value = config.customCss;
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            config.baseUrl = document.getElementById('base-url').value;
            config.apiKey = document.getElementById('api-key').value;
            config.model = document.getElementById('model-name').value;
            config.city = document.getElementById('set-city').value;
            config.weather = document.getElementById('set-weather').value;
            updateDisplay();
            saveToLocal();
            closeModal('settings-modal');
        }

        function savePreset() {
            config.systemPrompt = document.getElementById('system-prompt').value;
            saveToLocal();
            closeModal('preset-modal');
        }

        function saveBeauty() {
            config.customCss = document.getElementById('custom-css').value;
            document.getElementById('custom-theme').innerHTML += config.customCss;
            saveToLocal();
            closeModal('beauty-modal');
        }

        function saveToLocal() { localStorage.setItem('ai_config', JSON.stringify(config)); }

        function updateDisplay() {
            document.getElementById('display-city').innerText = config.city;
            document.getElementById('display-weather').innerText = config.weather;
            if(config.customCss) document.getElementById('custom-theme').innerHTML += config.customCss;
        }
        updateDisplay();

        // æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯
        function sendMsg() {
            const input = document.getElementById('user-input');
            if(!input.value) return;
            appendMsg('user', input.value);
            chatHistory.push({ role: "user", content: input.value });
            input.value = '';
        }

        function appendMsg(role, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // è°ƒç”¨ API
        async function generateAI() {
            if(!config.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™API Key");
            
            // æ„å»ºå¸¦æœ‰æ—¶ç©ºèƒŒæ™¯çš„ç³»ç»Ÿ Prompt
            const now = new Date();
            const fullSystemPrompt = `${config.systemPrompt} \nå½“å‰ç¯å¢ƒï¼šåŸå¸‚-${config.city}, å¤©æ°”-${config.weather}, æ—¶é—´-${now.toLocaleString()}`;

            // åªå–æœ€è¿‘5æ¬¡å¯¹è¯
            const recentHistory = chatHistory.slice(-5);
            
            appendMsg('ai', 'æ­£åœ¨è¾“å…¥...');

            try {
                const response = await axios.post(`${config.baseUrl}/chat/completions`, {
                    model: config.model,
                    messages: [
                        { role: "system", content: fullSystemPrompt },
                        ...recentHistory
                    ],
                    max_tokens: 100
                }, {
                    headers: { 'Authorization': `Bearer ${config.apiKey}` }
                });

                // ç§»é™¤â€œæ­£åœ¨è¾“å…¥â€
                const container = document.getElementById('chat-container');
                container.removeChild(container.lastChild);

                const reply = response.data.choices[0].message.content;
                // æ¨¡æ‹Ÿå¾®ä¿¡å¯èƒ½å‘å¤šæ¡çŸ­æ¶ˆæ¯ï¼ˆæŒ‰å¥å·æˆ–æ¢è¡Œåˆ‡åˆ†ï¼‰
                const segments = reply.split(/[ã€‚ï¼ï¼Ÿ\n]/).filter(s => s.trim().length > 0);
                
                segments.forEach(seg => {
                    appendMsg('ai', seg.substring(0, 20)); // å¼ºåˆ¶æˆªæ–­ä¿æŠ¤
                    chatHistory.push({ role: "assistant", content: seg });
                });

            } catch (error) {
                alert("API è°ƒç”¨å¤±è´¥: " + error.message);
            }
        }

        // æ¨¡æ‹Ÿæ‹‰å–æ¨¡å‹åˆ—è¡¨
        async function fetchModels() {
            if(!config.apiKey) return alert("è¯·å…ˆå¡«å†™API Key");
            try {
                const res = await axios.get(`${config.baseUrl}/models`, {
                    headers: { 'Authorization': `Bearer ${config.apiKey}` }
                });
                alert("æ‹‰å–æˆåŠŸï¼Œç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡å‹æ˜¯: " + res.data.data[0].id);
                document.getElementById('model-name').value = res.data.data[0].id;
            } catch(e) { alert("è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥"); }
        }
    </script>
</body>
</html>
