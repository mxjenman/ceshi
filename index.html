<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mobile OS - Plus Pro Max Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style id="custom-style">
        body { background: #f0f0f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; transition: background 0.5s ease; }
        /* èƒŒæ™¯é®ç½©ï¼Œç”¨äºæ›´æ¢å£çº¸ */
        #wallpaper-layer { position: fixed; inset: 0; z-index: -1; background-size: cover; background-position: center; }
        
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 24px; }
        .app-icon { width: 60px; height: 60px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; }
        .chat-msg-user { background: #95ec69; border-radius: 6px 0 6px 6px; }
        .chat-msg-ai { background: white; border-radius: 0 6px 6px 6px; }

        /* å°ç»„ä»¶æ ·å¼ */
        .widget-card{
            width:100%;
            border-radius:28px;
            padding:20px;
            background:linear-gradient(135deg,rgba(255,255,255,0.9),rgba(243,244,246,0.8));
            backdrop-filter: blur(10px);
            box-shadow:0 8px 20px rgba(0,0,0,0.08);
            position:relative;
        }
        .widget-avatar{
            width:60px;
            height:60px;
            border-radius:50%;
            object-fit:cover;
            border:3px solid white;
            box-shadow:0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .widget-emoji{
            font-size:14px;
            cursor:pointer;
        }
        .widget-text{
            position:absolute;
            bottom:15px;
            right:20px;
            font-size:12px;
            color:#555;
            cursor:pointer;
        }

        /* è®ºå›ä¸“æœ‰æ ·å¼ */
        .tweet-card { border-bottom: 1px solid #eff3f4; padding: 12px 16px; background: white; }
        .tweet-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        
        /* å‘å¸ƒé”® */
        .fab-btn { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; border-radius: 28px; background: #000000; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 24px; z-index: 60; cursor: pointer; transition: transform 0.1s; }
        .fab-btn:active { transform: scale(0.9); }
        
        /* æŒ‰é’®ç¦ç”¨æ ·å¼ */
        .btn-disabled { background-color: #cccccc !important; cursor: not-allowed !important; opacity: 0.6; }

        /* äº’åŠ¨å›¾æ ‡æ ·å¼ */
        .action-icon { width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 4px; opacity: 0.6; }
        .action-item:hover .action-icon { opacity: 1; }

        /* å¯¼èˆªå›¾æ ‡ç¼©æ”¾è¡¥ä¸ */
        .nav-sync-icon { width: 24px; height: 24px; object-fit: contain; }
        .back-icon { font-size: 20px; font-weight: 400; color: #000000; line-height: 1; }

        /* åº•éƒ¨Tabæ æ ·å¼ */
        .bottom-tab-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 65px; background: white; border-top: 1px solid #eff3f4; display: flex; justify-content: space-around; align-items: center; z-index: 65; padding-bottom: 15px; }
        .tab-item { display: flex; flex-direction: column; items-center; justify-content: center; color: #536471; font-size: 11px; flex: 1; height: 100%; transition: 0.2s; cursor: pointer; }
        .tab-item.active { color: #000000; font-weight: bold; }
        .tab-icon-svg { width: 22px; height: 22px; margin-bottom: 2px; fill: currentColor; }

        /* Twitter é£æ ¼åˆ—è¡¨ */
        .trend-item { padding: 12px 16px; border-bottom: 1px solid #eff3f4; }
        .msg-item { padding: 12px 16px; border-bottom: 1px solid #eff3f4; display: flex; gap: 12px; }
        .profile-header { height: 120px; background: #cfd9de; position: relative; cursor: pointer; background-size: cover; background-position: center; }
        .profile-avatar-large { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; position: absolute; bottom: -40px; left: 16px; background: #eee; cursor: pointer; object-fit: cover; }
        
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="wallpaper-layer"></div>

    <div id="home-screen" class="flex-1 p-6 flex flex-col items-center relative z-10">
        <div class="widget-card mb-12 mt-4">
            <div class="flex items-start gap-10">
                <div class="flex flex-col items-center gap-1">
                    <span class="widget-emoji" onclick="editEmoji('left')">(â¸â¸à¹‘  Ì« à¹‘â¸â¸)</span>
                    <img id="avatar-left" class="widget-avatar" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" onclick="changeAvatar('left')">
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="widget-emoji" onclick="editEmoji('right')">(Ë¶âƒ Ï‰ âƒË¶)</span>
                    <img id="avatar-right" class="widget-avatar" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" onclick="changeAvatar('right')">
                </div>
            </div>
            <div id="widget-text" class="widget-text" onclick="editWidgetText()">æˆ‘ä¸æƒ³éš”ç€å±å¹•å’Œä½ è¯´è¯</div>
            <div class="absolute top-2 left-2 text-[8px] opacity-20" onclick="changeSystemWallpaper()">ğŸ–¼ï¸ æ›´æ¢å£çº¸</div>
        </div>

        <div class="grid grid-cols-4 gap-6 w-full px-4">
            <div class="col-span-4 flex justify-end">
                <div class="flex flex-col items-center gap-1" onclick="openChat()">
                    <div class="app-icon overflow-hidden p-0">
                        <img src="https://i.postimg.cc/fycLsZLY/quality-restoration-20260228193355205.png" class="w-full h-full object-cover rounded-[15px]">
                    </div>
                    <span class="text-xs text-white drop-shadow-md">å¾®ä¿¡</span>
                </div>
            </div>

            <div class="col-span-4 flex justify-end mt-4">
                <div class="flex flex-col items-center gap-1" onclick="openForum()">
                    <div class="app-icon overflow-hidden p-0">
                        <img src="https://i.postimg.cc/ZnjMz01G/quality-restoration-20260228202408361.png" class="w-full h-full object-cover rounded-[15px]">
                    </div>
                    <span class="text-xs text-white drop-shadow-md">è®ºå›</span>
                </div>
            </div>
        </div>

        <div class="mt-auto glass-card w-full py-4 px-8 flex justify-between items-center mb-4">
            <button onclick="openModal('settings')" class="flex flex-col items-center">
                <span class="text-xl">âš™ï¸</span><span class="text-[10px]">è®¾ç½®</span>
            </button>
            <button onclick="openModal('beauty')" class="flex flex-col items-center">
                <span class="text-xl">ğŸ¨</span><span class="text-[10px]">ç¾åŒ–</span>
            </button>
            <button onclick="openModal('presets')" class="flex flex-col items-center">
                <span class="text-xl">ğŸ“‘</span><span class="text-[10px]">é¢„è®¾</span>
            </button>
        </div>
    </div>

    <div id="chat-screen" class="fixed inset-0 bg-[#ededed] hidden flex flex-col z-50">
        <div class="h-12 bg-[#ededed] flex items-center px-4 border-b border-gray-200">
            <button onclick="closeChat()" class="text-xl">ã€ˆ</button>
            <div class="flex-1 text-center font-bold">AI å¥½å‹</div>
            <div class="w-6"></div>
        </div>
        <div id="chat-flow" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-3 bg-[#f7f7f7] border-t flex flex-col gap-2">
            <div class="flex gap-2">
                <input id="chat-input" type="text" class="flex-1 border-none rounded bg-white px-3 py-2 outline-none" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="sendUserMsg()" class="bg-green-600 text-white px-4 py-2 rounded">å‘é€</button>
            </div>
            <button onclick="triggerAI()" id="gen-btn" class="w-full bg-blue-500 text-white py-1 rounded text-sm">ç‚¹å‡»ç”Ÿæˆå¯¹æ–¹å›å¤</button>
        </div>
    </div>

    <div id="forum-screen" class="fixed inset-0 bg-white hidden flex flex-col z-50 overflow-hidden">
        <div class="h-14 bg-white/80 backdrop-blur-md flex items-center px-4 border-b sticky top-0 z-10">
            <button onclick="closeForum()" class="back-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div id="forum-title" class="flex-1 text-center font-bold text-[16px] text-black">æ¨æ–‡</div>
            <button id="sync-btn" onclick="generateAIPosts()" class="flex items-center justify-center">
                <img src="https://i.postimg.cc/BntTBs0P/IMG-3094.png" class="nav-sync-icon">
            </button>
        </div>
        
        <div class="flex-1 overflow-hidden relative">
            <div id="tab-content-tweets" class="absolute inset-0 overflow-y-auto pb-20">
                <div id="forum-feed" class="bg-white">
                    <div id="empty-hint" class="p-10 text-center text-gray-400">æš‚æ— åŠ¨æ€ï¼Œç‚¹å‡»å³ä¸Šè§’åŒæ­¥å¹¿åœº</div>
                </div>
            </div>

            <div id="tab-content-trends" class="absolute inset-0 overflow-y-auto pb-20 hidden bg-[#f7f9f9]">
                <div class="bg-white mb-2">
                    <div class="p-4 font-black text-xl border-bottom">ä¸­å›½çƒ­æœæ¦œ</div>
                    <div class="trend-item">
                        <div class="text-xs text-gray-500">ç§‘æŠ€ Â· æ­£åœ¨çƒ­è®®</div>
                        <div class="font-bold">#Gemini 3 Flash ç§»åŠ¨ç«¯å‘å¸ƒ#</div>
                        <div class="text-xs text-gray-500">2.5ä¸‡ æ¨æ–‡</div>
                    </div>
                    <div class="trend-item">
                        <div class="text-xs text-gray-500">ç”Ÿæ´» Â· æ­£åœ¨çƒ­è®®</div>
                        <div class="font-bold">#2026 å¼€å¯å…¨æ–° AI çºªå…ƒ#</div>
                        <div class="text-xs text-gray-500">15.4ä¸‡ æ¨æ–‡</div>
                    </div>
                </div>
            </div>

            <div id="tab-content-messages" class="absolute inset-0 overflow-y-auto pb-20 hidden bg-white">
                <div class="p-4 font-black text-xl">ç§ä¿¡</div>
                <div class="msg-item">
                    <img src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" class="w-12 h-12 rounded-full sync-user-avatar">
                    <div>
                        <div class="flex gap-1"><span class="font-bold">ç³»ç»Ÿé€šçŸ¥</span><span class="text-gray-500">@system</span></div>
                        <div class="text-gray-500 text-sm">æ¬¢è¿æ¥åˆ°å…¨æ–°çš„ AI ç¤¾äº¤å¹¿åœºï¼</div>
                    </div>
                </div>
            </div>

            <div id="tab-content-profile" class="absolute inset-0 overflow-y-auto pb-20 hidden bg-white">
                <div id="profile-banner" class="profile-header" onclick="editProfileField('banner')">
                    <img id="profile-avatar-display" src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" class="profile-avatar-large sync-user-avatar" onclick="event.stopPropagation(); editProfileField('avatar')">
                </div>
                <div class="mt-12 px-4">
                    <button onclick="editFullProfile()" class="float-right border border-gray-300 rounded-full px-4 py-1 font-bold text-sm">ç¼–è¾‘èµ„æ–™</button>
                    <div id="display-nickname" class="font-black text-xl mt-4">æˆ‘</div>
                    <div id="display-handle" class="text-gray-500">@user_2026</div>
                    <div id="display-bio" class="mt-3 text-[15px]">ä¸€ä¸ªçƒ­çˆ±ç”Ÿæ´»ä¸ AI çš„æ¢ç´¢è€…ã€‚</div>
                    <div class="flex gap-4 mt-3 text-sm">
                        <span onclick="editProfileField('following')"><strong id="display-following" class="text-black">128</strong> <span class="text-gray-500">æ­£åœ¨å…³æ³¨</span></span>
                        <span onclick="editProfileField('followers')"><strong id="display-followers" class="text-black">1024</strong> <span class="text-gray-500">å…³æ³¨è€…</span></span>
                    </div>
                </div>
                <div class="flex border-b mt-4">
                    <div class="flex-1 text-center py-3 border-b-4 border-black font-bold">æ¨æ–‡</div>
                    <div class="flex-1 text-center py-3 text-gray-500">å›å¤</div>
                    <div class="flex-1 text-center py-3 text-gray-500">åª’ä½“</div>
                    <div class="flex-1 text-center py-3 text-gray-500">å–œæ¬¢</div>
                </div>
                <div id="user-own-posts"></div>
            </div>
        </div>

        <div class="bottom-tab-bar">
            <div class="tab-item active" onclick="switchTab('tweets')">
                <svg class="tab-icon-svg" viewBox="0 0 24 24"><path d="M21.58 13.91l-9-10a2 2 0 00-3.16 0l-9 10a2 2 0 001.58 3.42h1.58v6a2 2 0 002 2h8a2 2 0 002-2v-6h1.58a2 2 0 001.58-3.42z"></path></svg>
                <span>æ¨æ–‡</span>
            </div>
            <div class="tab-item" onclick="switchTab('trends')">
                <svg class="tab-icon-svg" viewBox="0 0 24 24"><path d="M21.53 20.47l-3.66-3.66a8 8 0 10-1.06 1.06l3.66 3.66a.75.75 0 101.06-1.06zM10 16.5a6.5 6.5 0 110-13 6.5 6.5 0 010 13z"></path></svg>
                <span>çƒ­ç‚¹</span>
            </div>
            <div class="tab-item" onclick="switchTab('messages')">
                <svg class="tab-icon-svg" viewBox="0 0 24 24"><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5a.5.5 0 00-.5.5v12.333L10.334 12 3.998 7.333V5.5a.5.5 0 00.5-.5zm14.5 0h-14v1.167L12 11.5l7-5.333V5zm.5 2.333L13.666 12l6.332 5.833V5.5a.5.5 0 00-.5-.5zm-1.167 11.167L12 12.5l-6.333 5.667h12.666z"></path></svg>
                <span>ç§ä¿¡</span>
            </div>
            <div class="tab-item" onclick="switchTab('profile')">
                <svg class="tab-icon-svg" viewBox="0 0 24 24"><path d="M17.863 13.44c1.477 1.58 2.366 3.8 2.366 6.31 0 .41-.34.75-.75.75H4.52a.75.75 0 01-.75-.75c0-2.51.889-4.73 2.366-6.31 1.252-1.34 3.163-2.19 5.864-2.19s4.612.85 5.863 2.19zm-5.863-1.94a4.5 4.5 0 110-9 4.5 4.5 0 010 9z"></path></svg>
                <span>ä¸»é¡µ</span>
            </div>
        </div>

        <div id="forum-fab" class="fab-btn" onclick="openCompose()">+</div>
    </div>

    <div id="compose-screen" class="fixed inset-0 bg-white hidden flex flex-col z-[70]">
        <div class="h-14 flex items-center justify-between px-4">
            <button onclick="closeCompose()" class="text-gray-700">å–æ¶ˆ</button>
            <button id="post-submit-btn" onclick="submitPost()" class="bg-black text-white px-4 py-1.5 rounded-full font-bold btn-disabled" disabled>å‘å¸ƒ</button>
        </div>
        <div class="p-4 flex gap-3">
            <img src="https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg" class="w-10 h-10 rounded-full sync-user-avatar">
            <div class="flex-1">
                <textarea id="post-text" class="w-full text-lg outline-none resize-none min-h-[150px]" placeholder="æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ" oninput="validatePostContent()"></textarea>
                <div id="post-image-preview" class="mt-2 hidden relative">
                    <img id="preview-img" src="" class="rounded-2xl w-full max-h-60 object-cover border">
                    <button onclick="clearPostImage()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center">Ã—</button>
                </div>
            </div>
        </div>
        <div class="mt-auto border-t p-4 flex items-center">
            <button onclick="triggerPostImage()" class="text-black text-2xl mr-4">ğŸ–¼ï¸</button>
            <span class="text-xs text-gray-400 italic">é€‰æ‹©ç›¸å†Œç…§ç‰‡</span>
            <input type="file" id="post-image-input" class="hidden" accept="image/*" onchange="previewPostImage(this)">
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl w-full max-h-[80vh] overflow-y-auto p-6 shadow-2xl">
            <div id="modal-content"></div>
            <button onclick="closeModal()" class="mt-6 w-full py-3 bg-gray-100 rounded-xl font-bold">ç¡®å®šå¹¶ä¿å­˜</button>
        </div>
    </div>

<script>
/* æ ¸å¿ƒé…ç½®ä¸çŠ¶æ€ */
let config = {
    baseUrl: 'https://api.openai.com/v1',
    apiKey: '',
    model: 'gpt-4o-mini',
    systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªçœŸå®çš„å¾®ä¿¡å¥½å‹ï¼Œå›å¤æç®€ï¼Œæ§åˆ¶åœ¨20å­—å†…ã€‚',
    userProfile: {
        nickname: 'æˆ‘',
        handle: '@user_2026',
        bio: 'ä¸€ä¸ªçƒ­çˆ±ç”Ÿæ´»ä¸ AI çš„æ¢ç´¢è€…ã€‚',
        following: '128',
        followers: '1024',
        avatar: 'https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg',
        banner: ''
    }
};
let chatHistory = [];

/* åˆå§‹åŒ–åŠ è½½ */
window.onload = () => {
    // æ¸²æŸ“åˆå§‹èµ„æ–™
    syncProfileUI();
};

/* --- 1. ç”¨æˆ·èµ„æ–™åŒæ­¥ç³»ç»Ÿ --- */
function syncProfileUI() {
    document.getElementById('display-nickname').innerText = config.userProfile.nickname;
    document.getElementById('display-handle').innerText = config.userProfile.handle;
    document.getElementById('display-bio').innerText = config.userProfile.bio;
    document.getElementById('display-following').innerText = config.userProfile.following;
    document.getElementById('display-followers').innerText = config.userProfile.followers;
    
    // åŒæ­¥æ‰€æœ‰å¤´åƒ
    const avatars = document.querySelectorAll('.sync-user-avatar');
    avatars.forEach(img => img.src = config.userProfile.avatar);
    document.getElementById('avatar-right').src = config.userProfile.avatar;

    // åŒæ­¥èƒŒæ™¯
    if(config.userProfile.banner) {
        document.getElementById('profile-banner').style.backgroundImage = `url(${config.userProfile.banner})`;
    }
}

function editFullProfile() {
    const p = config.userProfile;
    const content = document.getElementById('modal-content');
    document.getElementById('modal-overlay').classList.remove('hidden');
    content.innerHTML = `
        <h2 class="text-xl font-bold mb-4">ç¼–è¾‘ä¸ªäººèµ„æ–™</h2>
        <div class="space-y-3 text-sm">
            <div><p class="mb-1">æ˜µç§°</p><input id="edit-nick" class="w-full border p-2 rounded" value="${p.nickname}"></div>
            <div><p class="mb-1">ç”¨æˆ·å</p><input id="edit-handle" class="w-full border p-2 rounded" value="${p.handle}"></div>
            <div><p class="mb-1">ç®€ä»‹</p><textarea id="edit-bio" class="w-full border p-2 rounded">${p.bio}</textarea></div>
            <div class="flex gap-2">
                <div class="flex-1"><p class="mb-1">å…³æ³¨ä¸­</p><input id="edit-follow" class="w-full border p-2 rounded" value="${p.following}"></div>
                <div class="flex-1"><p class="mb-1">å…³æ³¨è€…</p><input id="edit-fans" class="w-full border p-2 rounded" value="${p.followers}"></div>
            </div>
        </div>
    `;
    // åŠ«æŒcloseModalé€»è¾‘
    const originalClose = window.closeModal;
    window.closeModal = function() {
        if(document.getElementById('edit-nick')) {
            config.userProfile.nickname = document.getElementById('edit-nick').value;
            config.userProfile.handle = document.getElementById('edit-handle').value;
            config.userProfile.bio = document.getElementById('edit-bio').value;
            config.userProfile.following = document.getElementById('edit-follow').value;
            config.userProfile.followers = document.getElementById('edit-fans').value;
            syncProfileUI();
        }
        document.getElementById('modal-overlay').classList.add('hidden');
        window.closeModal = originalClose;
    };
}

function editProfileField(field) {
    if(field === 'avatar' || field === 'banner') {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                const src = ev.target.result;
                if(field === 'avatar') config.userProfile.avatar = src;
                else config.userProfile.banner = src;
                syncProfileUI();
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        input.click();
    }
}

/* --- 2. ä¸»é¡µäº¤äº’é€»è¾‘ --- */
function changeSystemWallpaper() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'image/*';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById('wallpaper-layer').style.backgroundImage = `url(${ev.target.result})`;
        };
        reader.readAsDataURL(e.target.files[0]);
    };
    input.click();
}

function changeAvatar(side){
    const input=document.createElement('input');
    input.type='file'; input.accept='image/*';
    input.onchange=e=>{
        const reader=new FileReader();
        reader.onload=ev=>{ 
            const src = ev.target.result;
            document.getElementById(`avatar-${side}`).src=src; 
            if(side === 'right') {
                config.userProfile.avatar = src;
                syncProfileUI();
            }
        };
        reader.readAsDataURL(e.target.files[0]);
    };
    input.click();
}

function editEmoji(side){
    const el=document.querySelectorAll('.widget-emoji')[side==='left'?0:1];
    const result=prompt("ä¿®æ”¹é¢œæ–‡å­—",el.innerText);
    if(result) el.innerText=result;
}
function editWidgetText(){
    const el=document.getElementById('widget-text');
    const result=prompt("ä¿®æ”¹æ–‡æ¡ˆ",el.innerText);
    if(result) el.innerText=result;
}

/* --- 3. å¼¹çª—ä¸è®¾ç½® --- */
function openModal(type){
    const content=document.getElementById('modal-content');
    document.getElementById('modal-overlay').classList.remove('hidden');
    if(type==='settings'){
        content.innerHTML=`<h2 class="text-xl font-bold mb-4">API è®¾ç½®</h2><p class="text-xs mb-1">Base URL</p><input id="cfg-url" class="w-full border p-2 mb-3 rounded" value="${config.baseUrl}"><p class="text-xs mb-1">API Key</p><input id="cfg-key" type="password" class="w-full border p-2 mb-3 rounded" value="${config.apiKey}"><p class="text-xs mb-1">æ¨¡å‹åç§°</p><input id="cfg-model" class="w-full border p-2 mb-3 rounded" value="${config.model}">`;
    }else if(type==='beauty'){
        content.innerHTML=`<h2 class="text-xl font-bold mb-4">UI ç¾åŒ– (CSS)</h2><textarea id="cfg-css" class="w-full border p-2 h-40 font-mono text-sm" placeholder="ä¾‹å¦‚ï¼šbody { filter: grayscale(1); }">${config.customCss || ''}</textarea>`;
    }else if(type==='presets'){
        content.innerHTML=`<h2 class="text-xl font-bold mb-4">AI é¢„è®¾</h2><textarea id="cfg-prompt" class="w-full border p-2 h-40 text-sm">${config.systemPrompt}</textarea>`;
    }
}
function closeModal(){
    if(document.getElementById('cfg-url')){
        config.baseUrl=document.getElementById('cfg-url').value;
        config.apiKey=document.getElementById('cfg-key').value;
        config.model=document.getElementById('cfg-model').value;
    }
    if(document.getElementById('cfg-css')){
        config.customCss=document.getElementById('cfg-css').value;
        const style = document.getElementById('custom-style');
        style.innerHTML += config.customCss;
    }
    if(document.getElementById('cfg-prompt')){
        config.systemPrompt=document.getElementById('cfg-prompt').value;
    }
    document.getElementById('modal-overlay').classList.add('hidden');
}

/* --- 4. å¾®ä¿¡åŠŸèƒ½ --- */
function openChat(){document.getElementById('chat-screen').classList.remove('hidden');}
function closeChat(){document.getElementById('chat-screen').classList.add('hidden');}
function renderMsg(text,role){
    const container=document.getElementById('chat-flow');
    const div=document.createElement('div');
    div.className=`flex ${role==='user'?'justify-end':'justify-start'}`;
    div.innerHTML=`<div class="max-w-[80%] px-3 py-2 shadow-sm text-sm ${role==='user'?'chat-msg-user':'chat-msg-ai'}">${text}</div>`;
    container.appendChild(div);
    container.scrollTop=container.scrollHeight;
}
function sendUserMsg(){
    const input=document.getElementById('chat-input');
    if(!input.value)return;
    renderMsg(input.value,'user');
    chatHistory.push({role:'user',content:input.value});
    input.value='';
}
async function triggerAI(){
    if(!config.apiKey)return alert("è¯·å…ˆé…ç½® API Key");
    const btn=document.getElementById('gen-btn');
    btn.innerText="å¯¹æ–¹æ­£åœ¨è¾“å…¥..."; btn.disabled=true;
    try{
        const response=await fetch(`${config.baseUrl}/chat/completions`,{
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${config.apiKey}`},
            body:JSON.stringify({model:config.model,messages:[{role:'system',content:config.systemPrompt},...chatHistory.slice(-5)],max_tokens:100})
        });
        const data=await response.json();
        const reply=data.choices[0].message.content;
        renderMsg(reply.substring(0,30),'assistant');
        chatHistory.push({role:'assistant',content:reply});
    }catch(e){ renderMsg("ï¼ˆè¿æ¥è¶…æ—¶ï¼‰",'assistant'); }
    finally{ btn.innerText="ç‚¹å‡»ç”Ÿæˆå¯¹æ–¹å›å¤"; btn.disabled=false; }
}

/* --- 5. è®ºå›ä¸ Tab é€»è¾‘ --- */
function openForum(){ document.getElementById('forum-screen').classList.remove('hidden'); }
function closeForum(){ document.getElementById('forum-screen').classList.add('hidden'); }

function switchTab(tabId) {
    const ids = ['tweets', 'trends', 'messages', 'profile'];
    ids.forEach(id => document.getElementById(`tab-content-${id}`).classList.add('hidden'));
    
    const tabs = document.querySelectorAll('.tab-item');
    tabs.forEach(t => t.classList.remove('active'));

    const titles = { 'tweets': 'æ¨æ–‡', 'trends': 'æ­£åœ¨çƒ­æœ', 'messages': 'ç§ä¿¡', 'profile': 'ä¸»é¡µ' };
    document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');
    document.getElementById('forum-title').innerText = titles[tabId];

    const index = ids.indexOf(tabId);
    tabs[index].classList.add('active');

    const fab = document.getElementById('forum-fab');
    const syncBtn = document.getElementById('sync-btn');
    if(tabId === 'tweets') { fab.classList.remove('hidden'); syncBtn.classList.remove('hidden'); }
    else { fab.classList.add('hidden'); syncBtn.classList.add('hidden'); }
}

/* --- 6. å‘å¸–ä¸åŒæ­¥é€»è¾‘ --- */
function openCompose(){ 
    document.getElementById('compose-screen').classList.remove('hidden'); 
    syncProfileUI(); // ç¡®ä¿å‘å¸–å¤´åƒåŒæ­¥
    validatePostContent(); 
}
function closeCompose(){ 
    document.getElementById('compose-screen').classList.add('hidden');
    document.getElementById('post-text').value = '';
    clearPostImage();
}

function validatePostContent() {
    const text = document.getElementById('post-text').value.trim();
    const hasImg = !document.getElementById('post-image-preview').classList.contains('hidden');
    const btn = document.getElementById('post-submit-btn');
    btn.disabled = !(text.length > 0 || hasImg);
    btn.classList.toggle('btn-disabled', btn.disabled);
}

function triggerPostImage(){ document.getElementById('post-image-input').click(); }
function previewPostImage(input){
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('post-image-preview').classList.remove('hidden');
            validatePostContent();
        }
        reader.readAsDataURL(input.files[0]);
    }
}
function clearPostImage(){
    document.getElementById('post-image-input').value = '';
    document.getElementById('post-image-preview').classList.add('hidden');
    validatePostContent();
}

function submitPost(){
    const text = document.getElementById('post-text').value.trim();
    const hasImg = !document.getElementById('post-image-preview').classList.contains('hidden');
    const imgSrc = hasImg ? document.getElementById('preview-img').src : null;
    
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    
    // 1. å‘é€åˆ°å¹¿åœº
    addPostToFeed(config.userProfile.nickname, text, imgSrc, timeStr, true, config.userProfile.avatar, config.userProfile.handle);
    
    // 2. å‘é€åˆ°ä¸»é¡µæ¨æ–‡
    addPostToProfile(config.userProfile.nickname, text, imgSrc, timeStr, config.userProfile.avatar, config.userProfile.handle);
    
    closeCompose();
}

// å¹¿åœºæ¸²æŸ“å‡½æ•° (å¢å¼ºç‰ˆ)
function addPostToFeed(name, text, img, time, isUser=false, customAvatar=null, customHandle=null){
    const feed = document.getElementById('forum-feed');
    const hint = document.getElementById('empty-hint');
    if(hint) hint.remove();
    
    const div = document.createElement('div');
    div.className = "tweet-card flex gap-3";
    const avatar = customAvatar || (isUser ? config.userProfile.avatar : "https://i.postimg.cc/Qx8Y1m3R/IMG-2980.jpg");
    const handle = customHandle || (isUser ? config.userProfile.handle : "@anonymous");
    
    let imgHtml = img ? `<img src="${img}" class="mt-3 rounded-2xl border border-gray-100 max-h-80 w-full object-cover">` : "";

    div.innerHTML = `
        <img src="${avatar}" class="tweet-avatar ${isUser?'sync-user-avatar':''}">
        <div class="flex-1">
            <div class="flex items-center gap-1">
                <span class="font-bold text-[15px]">${name}</span>
                <span class="text-gray-500 text-[14px]">${handle} Â· ${time}</span>
            </div>
            <div class="text-[15px] mt-1 leading-normal">${text}</div>
            ${imgHtml}
            <div class="flex justify-between mt-3 text-gray-500 text-sm max-w-[280px]">
                <span class="action-item flex items-center"><img src="https://i.postimg.cc/Pp3dNw4Z/IMG-3090.png" class="action-icon"> 0</span>
                <span class="action-item flex items-center"><img src="https://i.postimg.cc/m1PB9gXN/IMG-3092.png" class="action-icon"> 0</span>
                <span class="action-item flex items-center"><img src="https://i.postimg.cc/dZhwCVHr/IMG-3091.png" class="action-icon"> 0</span>
                <span class="action-item flex items-center"><img src="https://i.postimg.cc/n9XpmhRT/IMG-3093.png" class="action-icon"> 0</span>
            </div>
        </div>
    `;
    feed.prepend(div);
}

// ä¸»é¡µæ¸²æŸ“å‡½æ•°
function addPostToProfile(name, text, img, time, avatar, handle){
    const container = document.getElementById('user-own-posts');
    const div = document.createElement('div');
    div.className = "tweet-card flex gap-3 border-t";
    let imgHtml = img ? `<img src="${img}" class="mt-3 rounded-2xl border border-gray-100 max-h-80 w-full object-cover">` : "";
    
    div.innerHTML = `
        <img src="${avatar}" class="tweet-avatar sync-user-avatar">
        <div class="flex-1">
            <div class="flex items-center gap-1">
                <span class="font-bold text-[15px]">${name}</span>
                <span class="text-gray-500 text-[14px]">${handle} Â· ${time}</span>
            </div>
            <div class="text-[15px] mt-1 leading-normal">${text}</div>
            ${imgHtml}
        </div>
    `;
    container.prepend(div);
}

async function generateAIPosts(){
    if(!config.apiKey) return alert("åŒæ­¥å¹¿åœºéœ€è¦é…ç½® API Key");
    const feed = document.getElementById('forum-feed');
    feed.innerHTML = '<div class="p-10 text-center text-blue-500 animate-pulse">æ­£åœ¨ç©¿æ¢­æ—¶ç©ºæŠ“å–åŠ¨æ€...</div>';
    
    try {
        const response = await fetch(`${config.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}`},
            body: JSON.stringify({
                model: config.model,
                messages: [{role: 'system', content: 'æ¨¡æ‹Ÿç”Ÿæˆ8æ¡æ¨æ–‡ï¼ŒJSONæ ¼å¼ï¼š{"posts":[{"name":"æ˜µç§°","handle":"@è´¦å·","text":"å†…å®¹"}]}.'}],
                response_format: { type: "json_object" }
            })
        });
        const data = await response.json();
        const posts = JSON.parse(data.choices[0].message.content).posts;
        feed.innerHTML = "";
        posts.forEach(p => {
            addPostToFeed(p.name, p.text, null, "åˆšåˆš", false, null, p.handle);
        });
    } catch(e) {
        feed.innerHTML = '<div class="p-10 text-center text-red-400">åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®</div>';
    }
}
</script>
</body>
</html>
