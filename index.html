<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI 桌面 - 独立人格持久化版</title>
    
    <link rel="apple-touch-icon" href="https://test.fukit.cn/autoupload/fr/PUOzIkT_hEAqz4elPzgm9kg93R44cerOKVobYyu6bmqyl5f0KlZfm6UsKj-HyTuv/20260224/IR8x/1206X1168/IMG_2714.jpeg">
    <link rel="icon" type="image/jpeg" href="https://test.fukit.cn/autoupload/fr/PUOzIkT_hEAqz4elPzgm9kg93R44cerOKVobYyu6bmqyl5f0KlZfm6UsKj-HyTuv/20260224/IR8x/1206X1168/IMG_2714.jpeg">
    <meta name="apple-mobile-web-app-title" content="我的桌面">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style id="user-custom-css">/* 用户美化注入 */</style>
    <style>
        :root { --bg-image: url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=2070'); --theme-color: #424243; }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        body { margin: 0; font-family: -apple-system, sans-serif; height: 100svh; overflow: hidden; background: #000; }
        .phone-screen { width: 100%; height: 100%; background: var(--bg-image) no-repeat center center; background-size: cover; position: relative; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); }

        .widget-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px); border-radius: 30px; margin: 19px 20px 10px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.3); }
        .avatar-wrap { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .avatar-img { width: 62px; height: 62px; border-radius: 50%; border: 2.5px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; background: #eee; }
        .name-tag { background: #fff; padding: 2px 14px; border-radius: 12px; font-size: 13px; font-weight: 800; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: relative; color: #333; }
        .name-tag::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #fff; }

        .dock { position: absolute; bottom: calc(-10px + env(safe-area-inset-bottom)); left: 20px; right: 20px; height: 75px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(30px); border-radius: 30px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.25); }
        
        .wechat-app { position: fixed; inset: 0; background: #ffffff; z-index: 100; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .wechat-header { 
            padding-top: calc(env(safe-area-inset-top) + 5px);
            background: #f2f2f2; 
            display: flex; 
            align-items: flex-end; 
            justify-content: space-between; 
            padding-left: 16px; 
            padding-right: 16px; 
            padding-bottom: 12px; 
            border-bottom: 0.5px solid #e0e0e0; 
            flex-shrink: 0;
            min-height: 44px;
        }

        .wechat-content { flex: 1; overflow-y: auto; background: #ffffff; }
        
        .wechat-nav { height: 60px; background: #f2f2f2; border-top: 0.5px solid #ddd; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: 500; color: #1a1a1a; transition: all 0.2s; padding-top: 3px; }
        .nav-item.active { color: #07c160; font-weight: 800; }

        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 6px; font-size: 15px; margin: 4px 0; position: relative; word-break: break-all; }
        .msg-user { background: #95ec69; align-self: flex-end; margin-right: 12px; }
        .msg-user::after { content: ''; position: absolute; right: -5px; top: 12px; border-left: 6px solid #95ec69; border-top: 6px solid transparent; border-bottom: 6px solid transparent; }
        .msg-ai { background: #ffffff; align-self: flex-start; margin-left: 12px; }
        .msg-ai::before { content: ''; position: absolute; left: -5px; top: 12px; border-right: 6px solid #ffffff; border-top: 6px solid transparent; border-bottom: 6px solid transparent; }
        
        .quote-box { background: rgba(0,0,0,0.06); border-left: 2px solid #bbb; padding: 2px 8px; font-size: 11px; color: #777; margin-bottom: 4px; border-radius: 2px; line-height: 1.4; }

        .me-profile-section { padding: 25px 24px 30px; background: #ffffff; margin-top: -5px; } 
        .me-avatar-circle { width: 85px; height: 85px; border-radius: 50%; border: 0.5px solid #eee; object-fit: cover; background: #fff; margin-bottom: 15px; cursor: pointer; }
        .me-info-row { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
        .me-id-label { font-size: 20px; font-weight: 600; color: #333; cursor: pointer; }
        .me-status-tag { border: 0.5px solid #ccc; padding: 2px 14px; font-size: 12px; color: #666; border-radius: 30px; display: flex; align-items: center; cursor: pointer; }
        .me-status-tag::before { content: '●'; color: #07c160; margin-right: 4px; font-size: 8px; }
        .me-at-account { font-size: 18px; font-weight: 500; color: #888; margin-top: 2px; cursor: pointer; }

        .me-menu-list { border-top: 0.5px solid #eee; background: #fff; flex: 1; }
        .me-menu-item { background: #fff; padding: 14px 24px; font-size: 16px; color: #111; border-bottom: 0.5px solid #f0f0f0; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; }
        .me-menu-item:active { background: #f9f9f9; }

        .chat-detail-page { position: absolute; inset: 0; background: #ffffff; z-index: 500; display: flex; flex-direction: column; animation: slideInRight 0.3s ease-out; }
        .detail-header { 
            padding-top: calc(env(safe-area-inset-top) + 10px); 
            padding-left: 20px; 
            padding-bottom: 10px; 
            display: flex;
            align-items: center;
        }
        .detail-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; background: #ffffff; }
        
        .detail-avatar-container {
            width: 100%;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            align-items: center; 
        }
        
        .detail-avatar { 
            width: 112px; 
            height: 112px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin-top: -5px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            cursor: pointer;
            transform: translateX(-120px); 
        }
        
        .detail-char-name { font-size: 24px; font-weight: 700; color: #000; margin-top: 22px; letter-spacing: 0.5px; text-align: center; cursor: pointer; }
        
        .detail-persona-box { margin-top: 12px; text-align: center; width: 85%; align-self: center; margin-bottom: 30px; }
        .detail-persona-text { font-size: 14px; color: #000; line-height: 1.5; font-weight: 400; opacity: 0.9; }
        .detail-persona-placeholder { font-size: 14px; color: #ccc; font-style: italic; }
        
        .detail-list-menu { border-top: 0.5px solid #eee; background: #fff; width: 100%; }

        .wallet-page { background: #f6f6f6; position: absolute; inset: 0; z-index: 200; display: flex; flex-direction: column; }
        .wallet-header-bg { background: linear-gradient(to bottom, var(--theme-color), #f6f6f6); height: 260px; position: absolute; top: 0; left: 0; right: 0; z-index: 0; }
        
        .wallet-nav-bar { 
            padding-top: calc(env(safe-area-inset-top) + 5px);
            display: flex; 
            align-items: flex-end; 
            justify-content: space-between; 
            padding-left: 16px; 
            padding-right: 16px; 
            padding-bottom: 12px; 
            color: white; 
            position: relative; 
            z-index: 10; 
        }

        .wallet-main-card { background: white; border-radius: 12px; margin: 0 16px; padding: 20px; position: relative; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .wallet-btn-group { display: flex; gap: 12px; margin-top: 40px; }
        .wallet-btn { flex: 1; height: 54px; border-radius: 27px; display: flex; justify-content: center; align-items: center; font-size: 17px; font-weight: 500; cursor: pointer; }
        .wallet-btn:active { opacity: 0.7; }
        .wallet-btn-outline { border: 1px solid #e0e0e0; color: #333; }
        .wallet-btn-primary { background: var(--theme-color); color: white; position: relative; }
        .badge-bubble { position: absolute; top: -12px; right: 0; background: #e8e8e8; color: var(--theme-color); font-size: 10px; padding: 2px 8px; border-radius: 10px; border: 1px solid #ddd; }
        
        .sub-page { position: absolute; inset: 0; background: #fefefe; z-index: 600; display: flex; flex-direction: column; animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateY(0); } }

        .inventory-icon { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .inventory-rotate { animation: twist 0.6s ease-in-out; }
        @keyframes twist { 0% { transform: rotate(0deg); } 33% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }

        .plus-icon-container { transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; }
        .plus-rotate-active { animation: plus-rotate 0.5s forwards ease-in-out; }
        @keyframes plus-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(180deg); }
        }

        .inventory-panel { position: absolute; bottom: 70px; left: 12px; width: 180px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 50; border: 1px solid rgba(0,0,0,0.05); transform-origin: bottom left; animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .inv-btn { background: #f7f7f7; padding: 8px; border-radius: 10px; text-align: center; font-size: 13px; color: #333; font-weight: 500; }
        .inv-btn:active { background: #ececec; }

        .chat-img { max-width: 150px; border-radius: 8px; margin: 4px 0; display: block; }

        .context-menu { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; min-width: 160px; z-index: 2000; box-shadow: 0 8px 30px rgba(0,0,0,0.25); overflow: hidden; animation: popIn 0.2s ease-out; }
        .menu-item { padding: 16px 20px; font-size: 15px; color: #333; border-bottom: 0.5px solid #f0f0f0; text-align: center; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #f5f5f5; }

        .msg-menu { position: fixed; background: #4c4c4c; border-radius: 8px; display: flex; padding: 4px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transform: translateX(-50%); }
        .msg-menu-item { color: white; padding: 8px 14px; font-size: 14px; border-right: 0.5px solid #666; white-space: nowrap; }
        .msg-menu-item:last-child { border-right: none; }
        .msg-menu::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #4c4c4c; }

        .menu-overlay { position: fixed; inset: 0; background: transparent; z-index: 999; }
        .menu-overlay-dark { position: fixed; inset: 0; background: rgba(0,0,0,0.1); z-index: 1999; }

        .multi-select-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: #f7f7f7; display: flex; justify-content: space-around; align-items: center; border-top: 0.5px solid #ddd; z-index: 110; padding-bottom: env(safe-area-inset-bottom); }
        .multi-select-btn { flex: 1; text-align: center; font-size: 16px; color: #1a1a1a; font-weight: 500; }
        .multi-select-btn.danger { color: #fa5151; }
        .quote-preview { background: #f0f0f0; padding: 8px 12px; border-top: 0.5px solid #ddd; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #666; }

        .discover-page { 
            background: #ededed; 
            height: 100%; 
            overflow-y: auto; 
            padding-top: calc(env(safe-area-inset-top) + 5px);
        }
        .moment-cover-wrap {
            margin-top: calc(-1 * (env(safe-area-inset-top) + 5px));
            height: 300px;
            position: relative;
        }

        .white-fill-layer {
            background-color: #ffffff !important;
        }

        .add-ai-modal {
            background: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 25px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .add-ai-label { font-size: 16px; color: #333; font-weight: 500; margin-left: 4px; }
        .add-ai-input {
            width: 100%;
            border: 1.5px solid #666;
            border-radius: 50px;
            padding: 10px 20px; font-size: 15px; outline: none; transition: border-color 0.3s;
        }
        .add-ai-input:focus { border-color: #07c160; }
        .add-ai-textarea {
            width: 100%; border: 1.5px solid #666; border-radius: 20px; padding: 15px 20px; font-size: 15px; min-height: 120px; outline: none; resize: none;
        }
        .add-ai-textarea:focus { border-color: #07c160; }
        .save-ai-btn { background: #000; color: #fff; border-radius: 50px; padding: 12px; font-weight: bold; text-align: center; margin-top: 10px; }
        .save-ai-btn:active { opacity: 0.8; }

        .desc-photo-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 3000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .desc-photo-card { background: #fff; width: 85%; max-width: 340px; border-radius: 30px; padding: 30px 24px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .desc-photo-title { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 12px; }
        .desc-photo-sub { font-size: 14px; color: #888; margin-bottom: 24px; line-height: 1.5; }
        .desc-photo-input-wrap { background: #f0f0f0; border-radius: 20px; padding: 12px 20px; margin-bottom: 24px; }
        .desc-photo-input { width: 100%; background: transparent; border: none; outline: none; font-size: 16px; color: #333; text-align: center; }
        .desc-photo-btns { display: flex; gap: 12px; }
        .desc-btn { flex: 1; padding: 14px; border-radius: 50px; font-weight: 700; font-size: 15px; transition: all 0.2s; }
        .desc-btn-cancel { background: #eee; color: #666; }
        .desc-btn-confirm { background: #333; color: #fff; }
        .desc-btn:active { transform: scale(0.95); opacity: 0.8; }

        .reply-btn-icon { width: 32px; height: 32px; object-fit: contain; cursor: pointer; transition: transform 0.2s, opacity 0.2s; }
        .reply-btn-icon:active { transform: scale(0.85); opacity: 0.7; }
        .reply-btn-disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

        .send-btn-icon { width: 54px; height: 32px; object-fit: contain; cursor: pointer; transition: transform 0.1s; }
        .send-btn-icon:active { transform: scale(0.92); }

        .more-dots-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; padding-bottom: 4px; }
        .more-dots-icon span { width: 4px; height: 4px; background: #1a1a1a; border-radius: 50%; display: inline-block; margin: 0 1.5px; }
    </style>
</head>
<body oncontextmenu="return false;"> 
<div id="app" class="phone-screen" @click="closeAllMenus">
    <input type="file" id="avatarPicker" accept="image/*" style="display: none" @change="onPhotoSelected">
    <input type="file" id="albumPicker" accept="image/*" style="display: none" @change="onAlbumPhotoSelected">
    <input type="file" id="cameraPicker" accept="image/*" capture="camera" style="display: none" @change="onCameraPhotoSelected">
    <input type="file" id="momentCoverPicker" accept="image/*" style="display: none" @change="onMomentCoverSelected">
    <input type="file" id="momentAvatarPicker" accept="image/*" style="display: none" @change="onMomentAvatarSelected">
    <input type="file" id="meAvatarPicker" accept="image/*" style="display: none" @change="onMeAvatarSelected">
    <input type="file" id="detailAvatarPicker" accept="image/*" style="display: none" @change="onDetailAvatarSelected">

    <div v-if="showDescPhotoModal" class="desc-photo-overlay" @click.self="showDescPhotoModal = false">
        <div class="desc-photo-card">
            <div class="desc-photo-title">发送照片</div>
            <div class="desc-photo-sub">用文字描述你要发出的照片<br>AI 将会收到这张“照片”</div>
            <div class="desc-photo-input-wrap">
                <input v-model="descPhotoInput" type="text" placeholder="比如：一张我在海边喝咖啡的照片" class="desc-photo-input" @keyup.enter="confirmDescPhoto">
            </div>
            <div class="desc-photo-btns">
                <button class="desc-btn desc-btn-cancel" @click="showDescPhotoModal = false">取消</button>
                <button class="desc-btn desc-btn-confirm" @click="confirmDescPhoto">确认</button>
            </div>
        </div>
    </div>

    <div class="widget-card">
        <div class="flex gap-6 mb-3 px-2">
            <div class="avatar-wrap" @click="handleAvatarClick('left')">
                <div class="name-tag" @click.stop="editWidgetName('left')">{{ widget.leftName }}</div>
                <img :src="widget.leftAvatar" class="avatar-img">
            </div>
            <div class="avatar-wrap" @click="handleAvatarClick('right')">
                <div class="name-tag" @click.stop="editWidgetName('right')">{{ widget.rightName }}</div>
                <img :src="widget.rightAvatar" class="avatar-img">
            </div>
        </div>
        <div class="w-full text-right pr-2" @click="editSign">
            <p class="text-gray-500 text-[12px] font-bold tracking-tight italic">{{ widget.signature }}</p>
        </div>
    </div>

    <div class="px-10 py-6">
        <div @click="openWechat" class="flex flex-col items-center w-14 active:scale-90 transition-all">
            <div class="w-14 h-14 bg-gradient-to-br from-[#09d36a] to-[#07c160] rounded-2xl flex items-center justify-center shadow-lg">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            </div>
            <span class="text-white text-[10px] mt-2 font-bold shadow-sm">私聊</span>
        </div>
    </div>

    <div class="dock">
        <div @click="activeModal = 'config'" class="flex flex-col items-center"><span class="text-2xl">⚙️</span><span class="text-[9px] mt-1 font-extrabold text-gray-800">设置</span></div>
        <div @click="activeModal = 'beauty'" class="flex flex-col items-center"><span class="text-2xl">✨</span><span class="text-[9px] mt-1 font-extrabold text-gray-800">美化</span></div>
        <div @click="activeModal = 'preset'" class="flex flex-col items-center"><span class="text-2xl">✍️</span><span class="text-[9px] mt-1 font-extrabold text-gray-800">预设</span></div>
    </div>

    <div v-if="chatVisible" class="wechat-app" @contextmenu.prevent>
        
        <div v-if="meSubPage === '聊天详情' && currentChatPartner" class="chat-detail-page">
            <div class="detail-header">
                <button @click="meSubPage = null" class="text-[#1a1a1a]">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                </button>
            </div>
            <div class="detail-content">
                <div class="detail-avatar-container">
                    <img :src="getFriendById(currentChatPartner.id).avatar" @click="changeDetailAvatar" class="detail-avatar">
                </div>
                
                <div class="detail-char-name" @click="editPartnerRemark">{{ getFriendById(currentChatPartner.id).name }}</div>
                
                <div class="detail-persona-box" @click="editDetailPersona">
                    <div v-if="getFriendById(currentChatPartner.id).persona" class="detail-persona-text">
                        {{ getFriendById(currentChatPartner.id).persona }}
                    </div>
                    <div v-else class="detail-persona-placeholder">点击输入美化文案，例如：“亲爱的雪人先生 为什么天一亮你就会不见呢?”</div>
                </div>

                <div class="detail-list-menu">
                    <div class="me-menu-item" @click="openBlankSubPage('功能一')">功能一</div>
                    <div class="me-menu-item" @click="openBlankSubPage('功能二')">功能二</div>
                    <div class="me-menu-item" @click="openBlankSubPage('功能三')">功能三</div>
                    <div class="me-menu-item" @click="openBlankSubPage('功能四')">功能四</div>
                    <div class="me-menu-item" @click="openBlankSubPage('功能五')">功能五</div>
                    <div class="me-menu-item" @click="openBlankSubPage('功能六')">功能六</div>
                </div>
                <div class="flex-1 bg-white"></div>
            </div>
        </div>

        <div v-if="meSubPage === '钱包'" class="wallet-page">
            <div class="wallet-header-bg"></div>
            <div class="wallet-nav-bar">
                <div @click="meSubPage = null" class="flex items-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg><span class="ml-1 text-lg font-medium">余额</span></div>
                <div class="text-2xl">···</div>
            </div>
            
            <div class="wallet-main-card">
                <div class="flex items-center justify-center gap-1 text-[var(--theme-color)] text-xs font-medium bg-blue-50/50 py-2 rounded-t-lg -mx-5 -mt-5 mb-6">
                    资金安全有保障 〉
                </div>
                <div class="flex flex-col items-center mt-4">
                    <div class="text-gray-600 text-[13px] flex items-center gap-1">可用余额(元) <img src="https://test.fukit.cn/autoupload/fr/qakEfOhNRG6o06DQb0_mtuPxZ2O0bsQcfNmgZJT0wpmyl5f0KlZfm6UsKj-HyTuv/20260225/ACrj/1000X1000/IMG_2974.png" class="w-4 h-4 object-contain"></div>
                    <div class="text-[44px] font-medium mt-3 leading-none cursor-pointer" @click="editBalance">{{ widget.balance || '19.77' }}</div>
                </div>
                <div class="wallet-btn-group">
                    <div class="wallet-btn wallet-btn-outline" @click="developingTip">提现</div>
                    <div class="wallet-btn wallet-btn-primary" @click="developingTip">
                        充值
                        <span class="badge-bubble">找人充</span>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex-1 overflow-y-auto px-4">
                <div class="bg-white rounded-lg p-4 flex justify-between items-center text-sm text-gray-400 mb-2">
                    <span class="text-gray-800 font-bold">全部记录</span>
                    <span class="flex items-center">全部 〉</span>
                </div>
                <div v-for="(record, idx) in billRecords" :key="idx" class="bg-white rounded-xl p-3 mb-2 flex items-center shadow-sm">
                    <img :src="record.avatar" class="w-10 h-10 rounded-lg mr-3">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800">{{ record.name }}</div>
                        <div class="text-[10px] text-gray-400">{{ record.time }}</div>
                    </div>
                    <div :class="['font-bold text-lg', record.amount > 0 ? 'text-[#07c160]' : 'text-black']">
                        {{ record.amount > 0 ? '+' : '' }}{{ record.amount }}
                    </div>
                </div>
            </div>
        </div>

        <div v-if="blankSubPageTitle" class="sub-page">
            <div class="wechat-header">
                <div class="w-8 flex">
                    <button @click="blankSubPageTitle = null" class="text-[#1a1a1a] pb-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                </div>
                <span class="font-bold text-[17px] pb-1">{{ blankSubPageTitle }}</span>
                <div class="w-8"></div>
            </div>
            <div class="wechat-content flex items-center justify-center text-gray-300 italic">
                此页面暂时为空
            </div>
        </div>

        <div v-if="meSubPage && !['钱包', '聊天详情'].includes(meSubPage)" class="sub-page">
            <div class="wechat-header">
                <div class="w-8 flex">
                    <button @click="meSubPage = null" class="text-[#1a1a1a] pb-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                </div>
                <span class="font-bold text-[17px] pb-1">{{ meSubPage }}</span>
                <div class="w-8"></div>
            </div>
            <div class="wechat-content"></div>
        </div>

        <div v-if="activeTab !== 'discover' || currentChatPartner" class="wechat-header">
            <div class="w-12 flex">
                <button v-if="activeTab === 'contacts' && !currentChatPartner" @click="chatVisible = false" class="text-[#1a1a1a] pb-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <button v-if="currentChatPartner" @click="exitChat" class="text-[#1a1a1a] pb-1">
                    <svg v-if="!isMultiSelect" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    <span v-else class="text-[15px]">取消</span>
                </button>
                <div v-if="(activeTab === 'discover' || activeTab === 'me') && !currentChatPartner" class="w-8"></div>
            </div>
            <span class="font-bold text-[17px] pb-1 truncate max-w-[60%]">{{ currentChatPartner ? (isMultiSelect ? '已选择' : getFriendById(currentChatPartner.id).name) : navTitle }}</span>
            <div class="w-12 flex justify-end">
                <button v-if="activeTab === 'contacts' && !currentChatPartner" @click="triggerPlusAction" class="text-[#1a1a1a] pb-1 text-2xl font-light">
                   <div class="plus-icon-container" :class="{'plus-rotate-active': isPlusRotating}">＋</div>
                </button>
                <div v-else-if="currentChatPartner && !isMultiSelect" class="more-dots-icon" @click="meSubPage = '聊天详情'">
                    <span></span><span></span><span></span>
                </div>
                <div v-else class="w-8"></div>
            </div>
        </div>

        <div class="wechat-content" :class="{'white-fill-layer': activeTab === 'me' || activeTab === 'contacts'}">
            <div v-if="activeTab === 'contacts'" class="h-full relative bg-white">
                <div v-if="!currentChatPartner" class="bg-white h-full">
                    <div class="p-2 px-4 bg-gray-50 text-[11px] text-gray-400 border-b flex justify-between items-center">
                        <span>当前状态: <span class="text-[#07c160] font-bold">{{ widget.userStatus }}</span></span>
                        <span class="italic">正在同步至 AI 视野...</span>
                    </div>
                    
                    <div v-for="f in filteredFriends" :key="f.id" 
                         @click="enterChat(f.id)"
                         @touchstart="handleTouchStart($event, f)"
                         @touchend="handleTouchEnd"
                         @mousedown="handleMouseDown($event, f)"
                         @mouseup="handleMouseUp"
                         class="p-4 border-b flex items-center justify-between active:bg-gray-50 bg-white">
                        <div class="flex items-center gap-3">
                            <img :src="f.avatar" class="w-10 h-10 rounded">
                            <div class="flex flex-col">
                                <span class="font-medium">{{ f.name }}</span>
                                <span class="text-[10px] text-gray-400">来自 AI 的特别问候</span>
                            </div>
                        </div>
                        <span v-if="f.isTop" class="text-[10px] bg-gray-100 text-gray-400 px-1 rounded">置顶</span>
                    </div>
                    <div class="h-20 bg-white"></div>
                </div>
                
                <div v-else class="flex flex-col h-full bg-[#ededed]">
                    <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-2" id="msg-box" @click="inventoryOpen = false">
                        <div v-for="(m, idx) in currentMessages" :key="idx" 
                             :id="'msg-' + idx"
                             :class="['msg-bubble', m.role==='user'?'msg-user':'msg-ai', isMultiSelect ? 'flex items-center gap-3' : '']"
                             @touchstart="handleMsgTouchStart($event, idx)"
                             @touchend="handleMsgTouchEnd"
                             @mousedown="handleMsgMouseDown($event, idx)"
                             @mouseup="handleMsgMouseUp">
                            <input v-if="isMultiSelect" type="checkbox" :value="idx" v-model="selectedMsgs" class="w-4 h-4 rounded-full border-gray-300">
                            <div class="flex flex-col">
                                <div v-if="m.quote" class="quote-box">「{{m.quote}}」</div>
                                <template v-if="m.type === 'image'">
                                    <img :src="m.content" class="chat-img">
                                </template>
                                <template v-else>{{m.content}}</template>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="inventoryOpen" class="inventory-panel">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="inv-btn" @click="triggerAlbum">相册</div>
                            <div class="inv-btn" @click="triggerCamera">相机</div>
                            <div class="inv-btn" @click="handleDescriptionPhoto">描述照片</div>
                            <div class="inv-btn" @click="developingTip">语音</div>
                            <div class="inv-btn" @click="developingTip">转账</div>
                            <div class="inv-btn" @click="developingTip">重回</div>
                        </div>
                    </div>

                    <div v-if="isMultiSelect" class="multi-select-bar">
                        <div class="multi-select-btn danger" @click="batchDeleteMsgs">删除({{selectedMsgs.length}})</div>
                    </div>

                    <div v-else class="flex flex-col bg-[#f7f7f7]">
                        <div v-if="quoteContent" class="quote-preview">
                            <span class="truncate pr-4">引用：{{quoteContent}}</span>
                            <span @click="quoteContent = null" class="px-2 text-xl">✕</span>
                        </div>
                        <div class="p-3 border-t flex gap-2 items-center relative">
                            <img src="https://test.fukit.cn/autoupload/fr/qakEfOhNRG6o06DQb0_mtuPxZ2O0bsQcfNmgZJT0wpmyl5f0KlZfm6UsKj-HyTuv/20260225/Y3Ew/1000X1000/IMG_3020.png" 
                                 @click="toggleInventory"
                                 class="w-7 h-7 inventory-icon cursor-pointer"
                                 :class="{'inventory-rotate': isRotating}">
                            
                            <input v-model="userInput" @keyup.enter="sendMsg()" placeholder="输入内容..." class="flex-1 bg-white p-2.5 rounded-md text-sm border-none outline-none">
                            
                            <img src="https://test.fukit.cn/autoupload/fr/qakEfOhNRG6o06DQb0_mtuPxZ2O0bsQcfNmgZJT0wpmyl5f0KlZfm6UsKj-HyTuv/20260225/1IAv/1000X1000/IMG_3018.png" 
                                 @click="triggerAIReply"
                                 class="reply-btn-icon"
                                 :class="{'reply-btn-disabled': isAIReplying}">

                            <img src="https://test.fukit.cn/autoupload/fr/qakEfOhNRG6o06DQb0_mtuPxZ2O0bsQcfNmgZJT0wpmyl5f0KlZfm6UsKj-HyTuv/20260225/e4qT/1000X1000/IMG_3019.png" 
                                 @click="sendMsg()" 
                                 class="send-btn-icon">
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'discover'" class="discover-page">
                <div class="moment-cover-wrap" @click="changeMomentCover">
                    <img :src="widget.momentCover || 'https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=1000'" class="w-full h-full object-cover">
                    <div class="absolute -bottom-6 right-4 flex items-center gap-3 z-50">
                        <span class="text-white font-bold shadow-sm mb-4" @click.stop="editMeName">{{ widget.meName }}</span>
                        <img :src="widget.momentAvatar || widget.rightAvatar" 
                             @click.stop="changeMomentAvatar"
                             class="w-16 h-16 rounded-lg border-2 border-white object-cover bg-white shadow-md">
                    </div>
                </div>
                <div class="mt-12 p-4 text-center text-gray-400 text-sm">暂无新动态</div>
            </div>

            <div v-if="activeTab === 'me'" class="bg-white h-full flex flex-col">
                <div class="me-profile-section">
                    <img :src="widget.meAvatar || widget.rightAvatar" 
                         @click="handleMeAvatarClick" 
                         class="me-avatar-circle">
                    
                    <div class="me-info-row">
                        <span class="me-id-label" @click="editMeName">{{ widget.meName }}</span>
                        <div class="me-status-tag" @click="editUserStatus">{{ widget.userStatus }}</div>
                    </div>
                    
                    <div @click="editWxId" class="me-at-account">
                        @{{ widget.wxId || 'xxxx_xxxx' }}
                    </div>
                </div>

                <div class="me-menu-list">
                    <div class="me-menu-item" @click="meSubPage = '钱包'">钱包</div>
                    <div class="me-menu-item" @click="meSubPage = '个人资料'">个人资料</div>
                    <div class="me-menu-item" @click="meSubPage = '设置'">设置</div>
                </div>
                <div class="flex-1 bg-white"></div>
            </div>
        </div>

        <div v-if="!currentChatPartner" class="wechat-nav">
            <div class="nav-item" :class="{active: activeTab==='contacts'}" @click="activeTab='contacts'">好友</div>
            <div class="nav-item" :class="{active: activeTab==='discover'}" @click="activeTab='discover'">朋友圈</div>
            <div class="nav-item" :class="{active: activeTab==='me'}" @click="activeTab='me'">我</div>
        </div>

        <div v-if="showFriendMenu" class="menu-overlay-dark" @click="showFriendMenu = false"></div>
        <div v-if="showMsgMenu" class="menu-overlay" @click="showMsgMenu = false"></div>

        <div v-if="showFriendMenu" class="context-menu" @click.stop>
            <div class="font-bold p-4 text-center text-gray-400 text-xs border-b">{{selectedFriend?.name}}</div>
            <div class="menu-item" @click.stop="toggleTop">{{selectedFriend?.isTop ? '取消置顶' : '置顶聊天'}}</div>
            <div class="menu-item text-red-500" @click.stop="deleteFriend">彻底删除</div>
        </div>

        <div v-if="showMsgMenu" class="msg-menu" :style="{top: msgMenuPos.y + 'px', left: msgMenuPos.x + 'px'}" @click.stop>
            <div class="msg-menu-item" @click.stop="deleteMsg">删除</div>
            <div class="msg-menu-item" @click.stop="editMsg">编辑</div>
            <div class="msg-menu-item" @click.stop="quoteMsg">引用</div>
            <div class="msg-menu-item" @click.stop="enterMultiSelect">多选</div>
        </div>
    </div>

    <div v-if="activeModal && activeModal !== 'addFriend'" class="fixed inset-0 bg-black/40 z-[200] flex items-end" @click.self="activeModal = null">
        <div class="bg-white w-full rounded-t-[30px] p-6 pb-12">
            <div class="flex justify-between items-center mb-6"><h3 class="font-extrabold">{{modalTitle}}</h3><button @click="activeModal = null">✕</button></div>
            <div v-if="activeModal==='config'" class="space-y-4">
                <input v-model="config.baseUrl" placeholder="API 地址" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm">
                <input v-model="config.apiKey" type="password" placeholder="API Key" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm">
                <input v-model="config.model" placeholder="模型名称" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm">
                <button @click="save" class="w-full bg-black text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">保存并应用</button>
            </div>
            <div v-else-if="activeModal==='beauty' || activeModal==='preset'" class="space-y-3">
                <textarea v-model="activeModal==='beauty'?config.beautyCss:config.presetCss" rows="6" class="w-full p-4 bg-gray-50 rounded-2xl border-none font-mono text-xs"></textarea>
                <button @click="save" class="w-full bg-black text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">保存并应用</button>
            </div>
        </div>
    </div>

    <div v-if="activeModal === 'addFriend'" class="fixed inset-0 bg-black/40 z-[2000] flex items-center justify-center" @click.self="activeModal = null">
        <div class="add-ai-modal">
            <div>
                <label class="add-ai-label">备注</label>
                <input v-model="newAI.remark" type="text" placeholder="给TA的备注" class="add-ai-input">
            </div>
            <div>
                <label class="add-ai-label">真名</label>
                <input v-model="newAI.realName" type="text" placeholder="TA知道自己叫什么" class="add-ai-input">
            </div>
            <div>
                <label class="add-ai-label">人格设定 (美化文案)</label>
                <textarea v-model="newAI.persona" placeholder="例如：亲爱的雪人先生 为什么天一亮你就会不见呢?" class="add-ai-textarea"></textarea>
            </div>
            <button @click="addNewFriend" class="save-ai-btn">保存联系人</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted, computed, nextTick, watch } = Vue;

const DEFAULT_WIDGET = {
    leftName: '雨雨雨～', leftAvatar: 'https://img.js.design/assets/static/7db8006d64b1509a2f66be951336a546.png',
    rightName: '雨', rightAvatar: 'https://img.js.design/assets/static/7db8006d64b1509a2f66be951336a546.png',
    meName: '雨', userStatus: '在线中',
    signature: '我不想隔着屏幕和你说话', wxId: 'AI_Habibi', balance: '19.77',
    momentCover: '', momentAvatar: '', meAvatar: ''
};

const DEFAULT_FRIENDS = [
    { id: 'left', name: '雨雨雨～', avatar: 'https://img.js.design/assets/static/7db8006d64b1509a2f66be951336a546.png', isTop: false, realName: '雨雨雨～', persona: '亲爱的雪人先生 为什么天一亮你就会不见呢?' },
    { id: 'ai', name: '哈吉米宝宝', avatar: 'https://test.fukit.cn/autoupload/fr/PUOzIkT_hEAqz4elPzgm9kg93R44cerOKVobYyu6bmqyl5f0KlZfm6UsKj-HyTuv/20260224/IR8x/1206X1168/IMG_2714.jpeg', isTop: false, realName: '哈吉米', persona: '一只可爱的猫咪，说话喜欢带喵' }
];

const DEFAULT_HISTORY = {
    left: [{ role: 'assistant', type: 'text', content: '雨雨雨～准备好聊天啦！' }],
    ai: [{ role: 'assistant', type: 'text', content: '我是哈吉米宝宝，你好呀！' }]
};

createApp({
    setup() {
        const config = ref({ baseUrl: '', apiKey: '', model: 'gpt-4o', beautyCss: '', presetCss: '' });
        const widget = ref({ ...DEFAULT_WIDGET });
        const friendsList = ref([...DEFAULT_FRIENDS]);
        const chatHistory = ref({ ...DEFAULT_HISTORY });
        const billRecords = ref([]);
        const newAI = ref({ remark: '', realName: '', persona: '' });

        const showDescPhotoModal = ref(false);
        const descPhotoInput = ref('');
        const isAIReplying = ref(false); 

        const saveAllData = () => {
            localStorage.setItem('ai_config_v4', JSON.stringify(config.value));
            localStorage.setItem('widget_v5', JSON.stringify(widget.value));
            localStorage.setItem('friends_list_v5', JSON.stringify(friendsList.value));
            localStorage.setItem('chat_history_v5', JSON.stringify(chatHistory.value));
            localStorage.setItem('bill_records', JSON.stringify(billRecords.value));
        };

        watch([config, widget, friendsList, chatHistory, billRecords], () => {
            saveAllData();
        }, { deep: true });

        const chatVisible = ref(false);
        const activeTab = ref('contacts');
        const activeModal = ref(null);
        const meSubPage = ref(null); 
        const blankSubPageTitle = ref(null); 
        const userInput = ref('');
        const currentEditSide = ref('');
        const inventoryOpen = ref(false);
        const isRotating = ref(false);
        const isPlusRotating = ref(false); 
        const showFriendMenu = ref(false);
        const selectedFriend = ref(null);
        const showMsgMenu = ref(false);
        const msgMenuPos = ref({ x: 0, y: 0 });
        const selectedMsgIdx = ref(null);
        const isMultiSelect = ref(false);
        const selectedMsgs = ref([]);
        const quoteContent = ref(null);
        const currentChatPartner = ref(null);

        const filteredFriends = computed(() => {
            return [...friendsList.value].sort((a, b) => (b.isTop - a.isTop));
        });
        const currentMessages = computed(() => {
            return currentChatPartner.value ? chatHistory.value[currentChatPartner.value.id] : [];
        });
        
        const navTitle = computed(() => ({ contacts: '好友', discover: '朋友圈', me: '' }[activeTab.value]));
        
        const modalTitle = computed(() => ({ 
            config: '参数配置', beauty: '界面美化', preset: '人格预设'
        }[activeModal.value]));

        const getFriendById = (id) => friendsList.value.find(f => f.id === id) || {};

        const openWechat = () => { chatVisible.value = true; activeTab.value = 'contacts'; currentChatPartner.value = null; meSubPage.value = null; };
        const enterChat = (id) => {
            if (showFriendMenu.value) return;
            const f = friendsList.value.find(item => item.id === id);
            currentChatPartner.value = { id, name: f.name };
            nextTick(() => { const box = document.getElementById('msg-box'); if(box) box.scrollTop = box.scrollHeight; });
        };
        const exitChat = () => {
            if(isMultiSelect.value) { isMultiSelect.value = false; selectedMsgs.value = []; } 
            else { currentChatPartner.value = null; }
        };

        const openBlankSubPage = (title) => {
            blankSubPageTitle.value = title;
        };

        const editDetailPersona = () => {
            if(!currentChatPartner.value) return;
            const friend = friendsList.value.find(f => f.id === currentChatPartner.value.id);
            const res = prompt("编辑文案：", friend.persona);
            if(res !== null) friend.persona = res;
        };

        // 新增：在详情页修改备注的功能
        const editPartnerRemark = () => {
            if(!currentChatPartner.value) return;
            const friend = friendsList.value.find(f => f.id === currentChatPartner.value.id);
            const newRemark = prompt("修改备注名：", friend.name);
            if(newRemark !== null && newRemark.trim() !== "") {
                friend.name = newRemark;
                // 如果是左侧快捷组件对应的好友，同步小组件显示
                if(friend.id === 'left') {
                    widget.value.leftName = newRemark;
                }
            }
        };

        const triggerPlusAction = () => {
            if (isPlusRotating.value) return;
            isPlusRotating.value = true;
            activeModal.value = 'addFriend';
            setTimeout(() => { isPlusRotating.value = false; }, 500);
        };

        const addNewFriend = () => {
            if(!newAI.value.remark || !newAI.value.realName) return alert("请填写备注和真名");
            const newId = 'ai_' + Date.now();
            const friendObj = {
                id: newId,
                name: newAI.value.remark, 
                realName: newAI.value.realName, 
                persona: newAI.value.persona || '亲爱的雪人先生 为什么天一亮你就会不见呢?', 
                avatar: 'https://test.fukit.cn/autoupload/fr/PUOzIkT_hEAqz4elPzgm9kg93R44cerOKVobYyu6bmyl5f0KlZfm6UsKj-HyTuv/20260225/lvES/1206X1203/IMG_2980.jpeg',
                isTop: false
            };
            friendsList.value.push(friendObj);
            chatHistory.value[newId] = [{ role: 'assistant', type: 'text', content: `你好，我是${newAI.value.realName}。` }];
            newAI.value = { remark: '', realName: '', persona: '' };
            activeModal.value = null;
        };

        const editWidgetName = (side) => {
            const newName = prompt("编辑小组件显示名字：", widget.value[side + 'Name']);
            if (newName) { 
                widget.value[side + 'Name'] = newName;
                if(side === 'left') {
                    const f = friendsList.value.find(item => item.id === 'left');
                    if(f) f.name = newName;
                }
            }
        };

        const editMeName = () => {
            const newName = prompt("修改 ID 昵称：", widget.value.meName);
            if (newName) { widget.value.meName = newName; }
        };

        const editUserStatus = () => {
            const newStatus = prompt("修改当前状态 (AI 将会看到此状态)：", widget.value.userStatus);
            if (newStatus) { widget.value.userStatus = newStatus; }
        };

        const handleTouchStart = (e, f) => { friendTimer = setTimeout(() => { selectedFriend.value = f; showFriendMenu.value = true; }, 600); };
        const handleTouchEnd = () => clearTimeout(friendTimer);
        const handleMouseDown = (e, f) => { friendTimer = setTimeout(() => { selectedFriend.value = f; showFriendMenu.value = true; }, 600); };
        const handleMouseUp = () => clearTimeout(friendTimer);
        const toggleTop = () => { selectedFriend.value.isTop = !selectedFriend.value.isTop; showFriendMenu.value = false; };
        const deleteFriend = () => {
            if(confirm(`确定删除 ${selectedFriend.value.name}？`)) {
                friendsList.value = friendsList.value.filter(f => f.id !== selectedFriend.value.id);
            }
            showFriendMenu.value = false;
        };

        const handleMsgTouchStart = (e, idx) => { if (isMultiSelect.value) return; msgTimer = setTimeout(() => { calcMsgMenuPos(idx); }, 600); };
        const handleMsgTouchEnd = () => clearTimeout(msgTimer);
        const handleMsgMouseDown = (e, idx) => { if (isMultiSelect.value) return; msgTimer = setTimeout(() => { calcMsgMenuPos(idx); }, 600); };
        const handleMsgMouseUp = () => clearTimeout(msgTimer);
        const calcMsgMenuPos = (idx) => {
            selectedMsgIdx.value = idx;
            const el = document.getElementById('msg-' + idx);
            if (el) {
                const rect = el.getBoundingClientRect();
                msgMenuPos.value = { x: rect.left + rect.width / 2, y: rect.top - 55 };
                showMsgMenu.value = true;
            }
        };

        const deleteMsg = () => { chatHistory.value[currentChatPartner.value.id].splice(selectedMsgIdx.value, 1); showMsgMenu.value = false; };
        const editMsg = () => {
            const targetMsg = chatHistory.value[currentChatPartner.value.id][selectedMsgIdx.value];
            if(targetMsg.type === 'image') return alert("图片无法编辑文本");
            const res = prompt("编辑消息：", targetMsg.content);
            if(res !== null) targetMsg.content = res;
            showMsgMenu.value = false;
        };
        const quoteMsg = () => {
            const targetMsg = chatHistory.value[currentChatPartner.value.id][selectedMsgIdx.value];
            quoteContent.value = targetMsg.type === 'image' ? '[图片]' : targetMsg.content;
            showMsgMenu.value = false;
        };
        const enterMultiSelect = () => { isMultiSelect.value = true; selectedMsgs.value = [selectedMsgIdx.value]; showMsgMenu.value = false; };
        const batchDeleteMsgs = () => {
            const partnerId = currentChatPartner.value.id;
            const sortedIdx = [...selectedMsgs.value].sort((a,b) => b-a);
            sortedIdx.forEach(i => chatHistory.value[partnerId].splice(i, 1));
            isMultiSelect.value = false;
            selectedMsgs.value = [];
        };

        const closeAllMenus = () => { showFriendMenu.value = false; showMsgMenu.value = false; };

        const editWxId = () => {
            const newId = prompt("编辑账号 (带@符号)：", widget.value.wxId);
            if (newId) widget.value.wxId = newId;
        };
        const handleAvatarClick = (side) => {
            currentEditSide.value = side;
            document.getElementById('avatarPicker').click();
        };
        const onPhotoSelected = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => { widget.value[currentEditSide.value + 'Avatar'] = event.target.result; };
            reader.readAsDataURL(file);
        };

        const handleMeAvatarClick = () => document.getElementById('meAvatarPicker').click();
        const onMeAvatarSelected = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => { widget.value.meAvatar = ev.target.result; };
                reader.readAsDataURL(file);
            }
        };

        const changeDetailAvatar = () => document.getElementById('detailAvatarPicker').click();
        const onDetailAvatarSelected = (e) => {
            const file = e.target.files[0];
            if (file && currentChatPartner.value) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const partnerId = currentChatPartner.value.id;
                    const friend = friendsList.value.find(f => f.id === partnerId);
                    if (friend) {
                        friend.avatar = ev.target.result;
                        if (partnerId === 'left') widget.value.leftAvatar = ev.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        const changeMomentCover = () => document.getElementById('momentCoverPicker').click();
        const onMomentCoverSelected = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => { widget.value.momentCover = ev.target.result; };
                reader.readAsDataURL(file);
            }
        };
        const changeMomentAvatar = () => document.getElementById('momentAvatarPicker').click();
        const onMomentAvatarSelected = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => { widget.value.momentAvatar = ev.target.result; };
                reader.readAsDataURL(file);
            }
        };

        const editSign = () => {
            const s = prompt("编辑个人签名：", widget.value.signature);
            if (s) widget.value.signature = s;
        };
        const editBalance = () => {
            const b = prompt("设置余额：", widget.value.balance);
            if (b !== null) widget.value.balance = b;
        };
        const developingTip = () => { alert("正在开发中"); };

        const toggleInventory = () => {
            isRotating.value = true;
            inventoryOpen.value = !inventoryOpen.value;
            setTimeout(() => { isRotating.value = false; }, 600);
        };
        const triggerAlbum = () => document.getElementById('albumPicker').click();
        const triggerCamera = () => document.getElementById('cameraPicker').click();
        const onAlbumPhotoSelected = (e) => handleImageUpload(e.target.files[0]);
        const onCameraPhotoSelected = (e) => handleImageUpload(e.target.files[0]);
        const handleImageUpload = (file) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => { sendMsg(event.target.result, 'image'); inventoryOpen.value = false; };
            reader.readAsDataURL(file);
        };

        const handleDescriptionPhoto = () => {
            showDescPhotoModal.value = true;
            descPhotoInput.value = '';
            inventoryOpen.value = false;
        };

        const confirmDescPhoto = () => {
            if (!descPhotoInput.value.trim()) return;
            sendMsg(descPhotoInput.value, 'desc_image');
            showDescPhotoModal.value = false;
            descPhotoInput.value = '';
        };

        const save = () => { 
            const styleEl = document.getElementById('user-custom-css');
            styleEl.innerHTML = (config.value.beautyCss || '') + (config.value.presetCss || '');
            saveAllData();
            activeModal.value = null; 
        };

        const sendMsg = async (content = null, type = 'text') => {
            const partnerId = currentChatPartner.value?.id;
            if (!partnerId) return;
            
            let msgContent = content || userInput.value;
            if (!msgContent && type === 'text') return;

            let userMsgObj = { role: 'user', type: 'text', content: msgContent, quote: quoteContent.value };
            if (type === 'image') { userMsgObj.type = 'image'; userMsgObj.content = msgContent; }
            else if (type === 'desc_image') {
                userMsgObj.type = 'image';
                userMsgObj.content = 'https://test.fukit.cn/autoupload/fr/qakEfOhNRG6o06DQb0_mtuPxZ2O0bsQcfNmgZJT0wpmyl5f0KlZfm6UsKj-HyTuv/20260225/n2hK/1000X1000/IMG_2987.png';
                userMsgObj.rawDesc = msgContent;
            }

            chatHistory.value[partnerId].push(userMsgObj);
            if (type === 'text') userInput.value = '';
            quoteContent.value = null;

            await nextTick();
            const box = document.getElementById('msg-box');
            if(box) box.scrollTop = box.scrollHeight;
        };

        const triggerAIReply = async () => {
            const partnerId = currentChatPartner.value?.id;
            if (!partnerId || isAIReplying.value) return;

            const targetFriend = friendsList.value.find(f => f.id === partnerId);
            isAIReplying.value = true;

            try {
                // AI 视角只会看到 realName 和 persona，不会看到用户修改的本地备注 name
                let aiSystemPrompt = `你现在是 ${targetFriend.realName}。对方叫 ${widget.value.meName}。对方目前的微信状态是“${widget.value.userStatus}”。你的核心设定：${targetFriend.persona}。额外预设：${config.value.presetCss}`;

                const res = await fetch(`${config.value.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${config.value.apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        model: config.value.model, 
                        messages: [
                            {role:'system', content: aiSystemPrompt}, 
                            ...chatHistory.value[partnerId].map(m => ({
                                role: m.role,
                                content: (m.quote ? `[引用: ${m.quote}] ` : '') + (m.rawDesc || (m.type === 'image' ? '[照片]' : m.content))
                            })).slice(-15)
                        ] 
                    })
                });
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;
                chatHistory.value[partnerId].push({ role: 'assistant', type: 'text', content: aiMsg });

                await nextTick();
                const box = document.getElementById('msg-box');
                if(box) box.scrollTop = box.scrollHeight;
            } catch (e) { 
                chatHistory.value[partnerId].push({ role: 'assistant', type: 'text', content: '连接失败，请检查配置。' }); 
            } finally {
                isAIReplying.value = false;
            }
        };

        onMounted(() => {
            const getLocal = (key, def) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : def;
            };
            config.value = getLocal('ai_config_v4', config.value);
            widget.value = getLocal('widget_v5', widget.value);
            friendsList.value = getLocal('friends_list_v5', friendsList.value);
            chatHistory.value = getLocal('chat_history_v5', chatHistory.value);
            billRecords.value = getLocal('bill_records', billRecords.value);

            const styleEl = document.getElementById('user-custom-css');
            styleEl.innerHTML = (config.value.beautyCss || '') + (config.value.presetCss || '');
        });

        let friendTimer = null;
        let msgTimer = null;

        return { 
            config, widget, chatVisible, activeTab, activeModal, meSubPage, blankSubPageTitle,
            userInput, currentChatPartner, currentMessages, navTitle, modalTitle,
            filteredFriends, showFriendMenu, handleTouchStart, handleTouchEnd, handleMouseDown, handleMouseUp, toggleTop, deleteFriend,
            showMsgMenu, msgMenuPos, isMultiSelect, selectedMsgs, quoteContent,
            handleMsgTouchStart, handleMsgTouchEnd, handleMsgMouseDown, handleMsgMouseUp,
            deleteMsg, editMsg, quoteMsg, enterMultiSelect, batchDeleteMsgs,
            editWidgetName, editMeName, editWxId, handleAvatarClick, onPhotoSelected, editSign, 
            save, sendMsg, openWechat, enterChat, exitChat, closeAllMenus,
            developingTip, editBalance, inventoryOpen, isRotating, isPlusRotating, triggerPlusAction, toggleInventory, billRecords,
            triggerAlbum, triggerCamera, onAlbumPhotoSelected, onCameraPhotoSelected, handleDescriptionPhoto,
            selectedFriend, changeMomentCover, onMomentCoverSelected,
            changeMomentAvatar, onMomentAvatarSelected,
            handleMeAvatarClick, onMeAvatarSelected, editUserStatus,
            newAI, addNewFriend,
            showDescPhotoModal, descPhotoInput, confirmDescPhoto,
            triggerAIReply, isAIReplying, getFriendById, changeDetailAvatar, onDetailAvatarSelected,
            editDetailPersona, openBlankSubPage, editPartnerRemark
        };
    }
}).mount('#app');
</script>
</body>
</html>
