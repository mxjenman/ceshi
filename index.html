<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI 桌面聊天</title>

<style>
/* ===== 基础样式 ===== */
body{
    margin:0;
    background:#dbeafe;
    font-family:-apple-system,BlinkMacSystemFont;
    display:flex;
    justify-content:center;
}
.phone{
    width:390px;
    height:844px;
    background:#f5f5f5;
    border-radius:40px;
    overflow:hidden;
    position:relative;
    box-shadow:0 0 30px rgba(0,0,0,0.3);
}

/* ===== 顶部云朵板块 ===== */
.top-cloud{
    background:linear-gradient(to bottom,#60a5fa,#93c5fd);
    padding:20px;
    color:white;
    border-bottom-left-radius:30px;
    border-bottom-right-radius:30px;
    position:relative;
}
.cloud-bg{
    background:white;
    color:#333;
    padding:15px;
    border-radius:30px;
}
.time{
    font-size:26px;
    font-weight:bold;
}
.date{
    font-size:14px;
}
.weather{
    margin-top:8px;
    font-size:14px;
}

/* ===== 私聊入口 ===== */
.chat-entry{
    margin:20px;
    text-align:center;
}
.chat-btn{
    background:#22c55e;
    color:white;
    padding:15px;
    border-radius:20px;
    cursor:pointer;
}

/* ===== 底部菜单 ===== */
.bottom-menu{
    position:absolute;
    bottom:0;
    width:100%;
    display:flex;
    justify-content:space-around;
    background:white;
    padding:10px 0;
}
.menu-item{
    font-size:14px;
    cursor:pointer;
}

/* ===== 聊天界面 ===== */
.chat-page{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:#e5ddd5;
    display:none;
    flex-direction:column;
}
.chat-header{
    padding:15px;
    background:#ededed;
}
.chat-body{
    flex:1;
    overflow-y:auto;
    padding:10px;
}
.message{
    margin:5px 0;
    max-width:70%;
    padding:8px;
    border-radius:10px;
}
.user{
    background:#95ec69;
    align-self:flex-end;
}
.ai{
    background:white;
    align-self:flex-start;
}
.chat-input{
    display:flex;
    padding:10px;
    background:white;
}
.chat-input input{
    flex:1;
    padding:8px;
}
.chat-input button{
    margin-left:5px;
}
</style>

<style id="custom-style"></style>

</head>
<body>

<div class="phone">

<!-- ===== 顶部板块 ===== -->
<div class="top-cloud">
    <div class="cloud-bg">
        <div class="time" id="time"></div>
        <div class="date" id="date"></div>
        <div class="weather">
            城市：<span id="city">Toronto</span> |
            天气：<span id="weatherText">晴</span>
        </div>
    </div>
</div>

<!-- ===== 私聊入口 ===== -->
<div class="chat-entry">
    <div class="chat-btn" onclick="openChat()">进入私聊</div>
</div>

<!-- ===== 底部菜单 ===== -->
<div class="bottom-menu">
    <div class="menu-item" onclick="openSettings()">设置</div>
    <div class="menu-item" onclick="openBeautify()">美化</div>
    <div class="menu-item" onclick="openPreset()">预设</div>
</div>

<!-- ===== 聊天界面 ===== -->
<div class="chat-page" id="chatPage">
    <div class="chat-header">
        私聊
        <button onclick="closeChat()">返回</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
        <input type="text" id="userInput">
        <button onclick="sendMessage()">发送</button>
        <button onclick="generateReply()">生成</button>
    </div>
</div>

</div>

<script>

/* ===== 时间同步 ===== */
function updateTime(){
    let now=new Date();
    document.getElementById("time").innerText=
        now.getHours().toString().padStart(2,"0")+":"+
        now.getMinutes().toString().padStart(2,"0");
    document.getElementById("date").innerText=
        now.getFullYear()+"-"+(now.getMonth()+1)+"-"+now.getDate();
}
setInterval(updateTime,1000);
updateTime();

/* ===== 聊天逻辑 ===== */
let messages=[];

function openChat(){
    document.getElementById("chatPage").style.display="flex";
}
function closeChat(){
    document.getElementById("chatPage").style.display="none";
}

function sendMessage(){
    let input=document.getElementById("userInput");
    if(!input.value) return;
    addMessage(input.value,"user");
    messages.push({role:"user",content:input.value});
    input.value="";
}

function addMessage(text,type){
    let div=document.createElement("div");
    div.className="message "+type;
    div.innerText=text;
    document.getElementById("chatBody").appendChild(div);
    document.getElementById("chatBody").scrollTop=99999;
}

/* ===== API 调用 ===== */
async function generateReply(){

    let baseUrl=localStorage.getItem("baseUrl");
    let apiKey=localStorage.getItem("apiKey");
    let model=localStorage.getItem("model");

    let city=document.getElementById("city").innerText;
    let weather=document.getElementById("weatherText").innerText;
    let preset=localStorage.getItem("preset")||"";

    let systemPrompt=`
你正在和用户私聊。
当前时间:${document.getElementById("time").innerText}
日期:${document.getElementById("date").innerText}
城市:${city}
天气:${weather}

你必须像真实人类一样聊天：
- 不要暴露自己是AI
- 语气自然口语化
- 可以犹豫、停顿、情绪
- 每条回复不超过20字
- 可以分成多条发送
- 不要长篇大论
- 不要解释规则
${preset}
`;

    let lastFive=messages.slice(-5);

    let body={
        model:model,
        messages:[
            {role:"system",content:systemPrompt},
            ...lastFive
        ]
    };

    let res=await fetch(baseUrl,{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+apiKey
        },
        body:JSON.stringify(body)
    });

    let data=await res.json();
    let reply=data.choices[0].message.content;

    reply.split("\n").forEach(r=>{
        if(r.trim()){
            addMessage(r.trim(),"ai");
            messages.push({role:"assistant",content:r.trim()});
        }
    });
}

/* ===== 设置 ===== */
function openSettings(){
    let base=prompt("BaseURL",localStorage.getItem("baseUrl")||"");
    let key=prompt("API Key",localStorage.getItem("apiKey")||"");
    let model=prompt("Model Name",localStorage.getItem("model")||"gpt-4o-mini");
    if(base) localStorage.setItem("baseUrl",base);
    if(key) localStorage.setItem("apiKey",key);
    if(model) localStorage.setItem("model",model);
    alert("已保存");
}

/* ===== 预设 ===== */
function openPreset(){
    let preset=prompt("输入预设规则",localStorage.getItem("preset")||"");
    if(preset){
        localStorage.setItem("preset",preset);
        alert("预设已保存");
    }
}

/* ===== 美化 ===== */
function openBeautify(){
    let css=prompt("输入自定义CSS",localStorage.getItem("beautify")||"");
    if(css){
        localStorage.setItem("beautify",css);
        document.getElementById("custom-style").innerHTML=css;
        alert("美化已生效");
    }
}
document.getElementById("custom-style").innerHTML=
    localStorage.getItem("beautify")||"";

</script>

</body>
</html>
