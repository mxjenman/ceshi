<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mobile Desktop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style id="custom-styles">
        :root {
            --bg-image: url('https://images.unsplash.com/photo-1557683316-973673baf926');
            --card-bg: rgba(255, 255, 255, 0.7);
        }
        body {
            background: var(--bg-image) no-repeat center center fixed;
            background-size: cover;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        .cloud-panel {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .app-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        /* å¾®ä¿¡å¯¹è¯é£æ ¼ */
        .chat-bubble-user {
            background-color: #95ec69;
            position: relative;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
        }
        .hidden-panel { display: none; }
    </style>
</head>
<body class="flex flex-col p-4">

    <div class="cloud-panel p-6 mb-8 mt-4 transition-all" id="top-panel">
        <div class="flex justify-between items-center">
            <div>
                <h1 id="time-display" class="text-4xl font-bold text-gray-800">12:00</h1>
                <p id="date-display" class="text-sm text-gray-600">2023å¹´10æœˆ27æ—¥ æ˜ŸæœŸäº”</p>
            </div>
            <div class="text-right">
                <p id="city-display" class="text-lg font-medium text-gray-800">ç‚¹å‡»è®¾ç½®åŸå¸‚</p>
                <p id="weather-display" class="text-sm text-gray-600">æ™´ 25Â°C</p>
            </div>
        </div>
    </div>

    <div class="flex-grow grid grid-cols-4 gap-4 content-start">
        <div class="flex flex-col items-center gap-2" onclick="openChat()">
            <div class="app-icon bg-green-500 text-white text-3xl">ğŸ’¬</div>
            <span class="text-xs text-white font-bold">ç§èŠ</span>
        </div>
    </div>

    <div class="flex justify-around items-center bg-white/30 backdrop-blur-md rounded-full p-4 mb-4">
        <button onclick="togglePanel('settings')" class="text-2xl">âš™ï¸</button>
        <button onclick="togglePanel('beauty')" class="text-2xl">âœ¨</button>
        <button onclick="togglePanel('presets')" class="text-2xl">ğŸ“œ</button>
    </div>

    <div id="settings" class="fixed inset-0 bg-black/50 hidden-panel z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6">
            <h2 class="text-xl font-bold mb-4">API è®¾ç½®</h2>
            <input id="baseUrl" type="text" placeholder="Base URL (https://api.openai.com/v1)" class="w-full border p-2 mb-2 rounded">
            <input id="apiKey" type="password" placeholder="API Key" class="w-full border p-2 mb-2 rounded">
            <input id="modelName" type="text" placeholder="Model Name (gpt-3.5-turbo)" class="w-full border p-2 mb-4 rounded">
            <button onclick="saveSettings()" class="w-full bg-blue-500 text-white p-2 rounded-lg">ä¿å­˜å¹¶å…³é—­</button>
        </div>
    </div>

    <div id="beauty" class="fixed inset-0 bg-black/50 hidden-panel z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6">
            <h2 class="text-xl font-bold mb-4">ä¸ªæ€§åŒ– (CSS)</h2>
            <textarea id="customCss" placeholder="è¾“å…¥CSSä»£ç ï¼Œå¦‚ :root { --bg-image: url(...) }" class="w-full h-40 border p-2 mb-4 rounded text-xs"></textarea>
            <button onclick="saveBeauty()" class="w-full bg-purple-500 text-white p-2 rounded-lg">åº”ç”¨æ ·å¼</button>
        </div>
    </div>

    <div id="presets" class="fixed inset-0 bg-black/50 hidden-panel z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6">
            <h2 class="text-xl font-bold mb-4">AI è¡Œä¸ºé¢„è®¾</h2>
            <textarea id="aiPrompt" placeholder="è§„å®šAIçš„æ€§æ ¼ã€å›å¤è§„åˆ™..." class="w-full h-40 border p-2 mb-4 rounded text-sm"></textarea>
            <button onclick="savePresets()" class="w-full bg-orange-500 text-white p-2 rounded-lg">ä¿å­˜é¢„è®¾</button>
        </div>
    </div>

    <div id="chat-window" class="fixed inset-0 bg-[#ededed] z-[60] hidden flex flex-col">
        <div class="bg-[#ededed] p-4 flex items-center border-b">
            <button onclick="closeChat()" class="mr-4">â—€</button>
            <span class="font-bold">é€šè®¯å½•å¥½å‹</span>
        </div>
        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4">
            </div>
        <div class="bg-[#f7f7f7] p-4 border-t flex items-center gap-2">
            <input id="user-input" type="text" class="flex-grow p-2 rounded border" placeholder="å‘é€æ¶ˆæ¯...">
            <button onclick="sendMessage()" class="bg-green-600 text-white px-4 py-2 rounded">å‘é€</button>
            <button onclick="generateAI()" class="bg-blue-600 text-white px-4 py-2 rounded">ç”Ÿæˆ</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---

        // 1. åˆå§‹åŒ–æ—¶é—´
        function updateTime() {
            const now = new Date();
            document.getElementById('time-display').innerText = now.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('date-display').innerText = now.toLocaleDateString('zh-CN', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'});
        }
        setInterval(updateTime, 1000);
        updateTime();

        // 2. çŠ¶æ€ç®¡ç†
        let chatHistory = [];
        let config = JSON.parse(localStorage.getItem('ai_config')) || { baseUrl: '', apiKey: '', modelName: 'gpt-3.5-turbo' };
        let beauty = localStorage.getItem('ai_beauty') || "";
        let preset = localStorage.getItem('ai_preset') || "ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨ç”¨å¾®ä¿¡å’Œæœ‹å‹èŠå¤©çš„çœŸå®äººç±»ã€‚";

        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        document.getElementById('baseUrl').value = config.baseUrl;
        document.getElementById('apiKey').value = config.apiKey;
        document.getElementById('modelName').value = config.modelName;
        document.getElementById('customCss').value = beauty;
        document.getElementById('aiPrompt').value = preset;
        applyStyles(beauty);

        function togglePanel(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden-panel');
        }

        function saveSettings() {
            config = {
                baseUrl: document.getElementById('baseUrl').value,
                apiKey: document.getElementById('apiKey').value,
                modelName: document.getElementById('modelName').value
            };
            localStorage.setItem('ai_config', JSON.stringify(config));
            togglePanel('settings');
        }

        function saveBeauty() {
            const css = document.getElementById('customCss').value;
            localStorage.setItem('ai_beauty', css);
            applyStyles(css);
            togglePanel('beauty');
        }

        function applyStyles(css) {
            let styleEl = document.getElementById('injected-styles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'injected-styles';
                document.head.appendChild(styleEl);
            }
            styleEl.innerHTML = css;
        }

        function savePresets() {
            preset = document.getElementById('aiPrompt').value;
            localStorage.setItem('ai_preset', preset);
            togglePanel('presets');
        }

        // 3. èŠå¤©é€»è¾‘
        function openChat() { document.getElementById('chat-window').classList.remove('hidden'); }
        function closeChat() { document.getElementById('chat-window').classList.add('hidden'); }

        function sendMessage() {
            const input = document.getElementById('user-input');
            if (!input.value) return;
            
            const msg = { role: 'user', content: input.value };
            chatHistory.push(msg);
            renderMessage('user', input.value);
            input.value = '';
        }

        function renderMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[70%] p-3 rounded-lg text-sm ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai shadow-sm'}">
                    ${text}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // 4. API è°ƒç”¨
        async function generateAI() {
            if (!config.apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API");

            const systemPrompt = `${preset}. 
            å½“å‰ç¯å¢ƒä¿¡æ¯ï¼šæ—¶é—´ ${new Date().toLocaleString()}, åŸå¸‚ ${document.getElementById('city-display').innerText}, å¤©æ°” ${document.getElementById('weather-display').innerText}.
            è¦æ±‚ï¼šä½ ç°åœ¨æ˜¯åœ¨å¾®ä¿¡ä¸ŠèŠå¤©ã€‚è¯´è¯è¦åƒçœŸäººï¼Œå£è¯­åŒ–ï¼Œå¤šç”¨è¯­æ°”è¯ï¼Œä¸è¦æœ‰AIæ„Ÿã€‚
            é‡è¦è§„åˆ™ï¼šä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å†³å®šå‘é€1åˆ°3æ¡çŸ­æ¶ˆæ¯ï¼Œä¸è¦åˆå¹¶æˆä¸€æ®µã€‚æ¯æ¡æ¶ˆæ¯å¿…é¡»æ§åˆ¶åœ¨20å­—ä»¥å†…ã€‚`;

            // å–æœ€å5æ¬¡å¯¹è¯
            const context = chatHistory.slice(-5);

            try {
                const response = await fetch(`${config.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.modelName,
                        messages: [{ role: 'system', content: systemPrompt }, ...context]
                    })
                });

                const data = await response.json();
                const reply = data.choices[0].message.content;
                
                // æ¨¡æ‹ŸçœŸäººåˆ†æ¡å‘é€æ•ˆæœ
                const parts = reply.split(/[ï¼Œã€‚ï¼ï¼Ÿ\n]/).filter(p => p.trim().length > 0);
                for(let part of parts.slice(0, 3)) {
                    await new Promise(r => setTimeout(r, 800)); // æ¨¡æ‹Ÿè¾“å…¥å»¶è¿Ÿ
                    renderMessage('assistant', part);
                    chatHistory.push({ role: 'assistant', content: part });
                }
            } catch (error) {
                console.error(error);
                alert("è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ–ç½‘ç»œ");
            }
        }

        // åŸå¸‚/å¤©æ°”è‡ªä¸»è®¾ç½®
        document.getElementById('top-panel').onclick = () => {
            const city = prompt("è®¾ç½®æ‰€åœ¨åŸå¸‚:", "åŒ—äº¬");
            const weather = prompt("è®¾ç½®å¤©æ°”çŠ¶æ€:", "æ™´ 25Â°C");
            if(city) document.getElementById('city-display').innerText = city;
            if(weather) document.getElementById('weather-display').innerText = weather;
        };
    </script>
</body>
</html>
