<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI OS Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-image: url('https://images.unsplash.com/photo-1557683316-973673baf926');
            --glass-bg: rgba(255, 255, 255, 0.2);
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            height: 100vh;
            overflow: hidden;
            color: white;
        }
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cloud-panel {
            border-radius: 40px 40px 80px 80px;
            padding: 20px;
            text-align: center;
            margin: 20px;
        }
        .hidden { display: none; }
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }
        #chat-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f3f3f3;
            z-index: 100;
            display: none;
            flex-direction: column;
            color: black;
        }
        .msg-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 15px;
            word-wrap: break-word;
        }
        .msg-left { background: white; align-self: flex-start; }
        .msg-right { background: #95ec69; align-self: flex-end; }
    </style>
</head>
<body>

    <div id="home-screen" class="flex flex-col h-full">
        <div id="top-panel" class="glass cloud-panel mt-10">
            <div id="time" class="text-5xl font-light mb-1">00:00</div>
            <div id="date" class="text-sm opacity-80 mb-2">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            <div class="flex justify-center gap-2 text-sm">
                <span id="display-city">åŒ—äº¬</span>
                <span id="display-weather">æ™´ 25Â°C</span>
            </div>
        </div>

        <div class="flex-1 p-6 grid grid-cols-4 gap-6 content-start">
            <div onclick="openChat()" class="flex flex-col items-center gap-1">
                <div class="app-icon bg-green-500 shadow-lg">ğŸ’¬</div>
                <span class="text-xs">ç§èŠ</span>
            </div>
        </div>

        <div class="glass m-4 p-4 rounded-3xl flex justify-around items-center">
            <div onclick="openModal('settings')" class="text-2xl cursor-pointer">âš™ï¸</div>
            <div onclick="openModal('beauty')" class="text-2xl cursor-pointer">âœ¨</div>
            <div onclick="openModal('preset')" class="text-2xl cursor-pointer">ğŸ“</div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-[200] flex items-center justify-center p-4">
        <div class="bg-white text-black w-full max-w-sm rounded-2xl p-6 overflow-y-auto max-h-[80vh]">
            <h2 id="modal-title" class="text-xl font-bold mb-4">æ ‡é¢˜</h2>
            <div id="modal-content"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-lg mr-2">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="chat-window" class="flex flex-col">
        <div class="bg-[#ededed] p-4 flex items-center border-b">
            <button onclick="closeChat()" class="mr-4">â—€</button>
            <div class="font-bold flex-1" id="chat-title">å¯¹æ–¹</div>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col">
            </div>
        <div class="p-3 bg-[#f7f7f7] flex gap-2 border-t">
            <input id="chat-input" type="text" class="flex-1 border rounded px-3 py-2 outline-none" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <button onclick="sendUserMsg()" class="bg-[#07c160] text-white px-4 py-2 rounded">å‘é€</button>
            <button onclick="generateAI()" class="bg-blue-500 text-white px-4 py-2 rounded">ç”Ÿæˆ</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let config = {
            baseUrl: localStorage.getItem('baseUrl') || '',
            apiKey: localStorage.getItem('apiKey') || '',
            model: localStorage.getItem('model') || '',
            city: 'åŒ—äº¬',
            weather: 'æ™´ 25Â°C',
            preset: 'ä½ æ˜¯ä¸€ä¸ªäººç±»å¥½å‹ï¼Œè¯´è¯ç®€çŸ­ã€‚',
            customCss: ''
        };

        let chatHistory = [];

        // --- åˆå§‹åŒ– ---
        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            applyBeauty();
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('time').innerText = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('date').innerText = now.toLocaleDateString('zh-CN', options);
        }

        // --- æ¨¡æ€æ¡†é€»è¾‘ ---
        function openModal(type) {
            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            overlay.classList.remove('hidden');

            if (type === 'settings') {
                title.innerText = 'API è®¾ç½®';
                content.innerHTML = `
                    <label class="block text-sm mb-1">Base URL</label>
                    <input id="in-url" class="w-full border p-2 mb-3 rounded" value="${config.baseUrl}">
                    <label class="block text-sm mb-1">API Key</label>
                    <input id="in-key" type="password" class="w-full border p-2 mb-3 rounded" value="${config.apiKey}">
                    <label class="block text-sm mb-1">æ¨¡å‹åç§°</label>
                    <input id="in-model" class="w-full border p-2 mb-3 rounded" value="${config.model}">
                `;
            } else if (type === 'beauty') {
                title.innerText = 'å¤–è§‚ç¾åŒ–';
                content.innerHTML = `
                    <label class="block text-sm mb-1">åŸå¸‚</label>
                    <input id="in-city" class="w-full border p-2 mb-3 rounded" value="${config.city}">
                    <label class="block text-sm mb-1">å¤©æ°”</label>
                    <input id="in-weather" class="w-full border p-2 mb-3 rounded" value="${config.weather}">
                    <label class="block text-sm mb-1">è‡ªå®šä¹‰CSS (èƒŒæ™¯/å›¾æ ‡ç­‰)</label>
                    <textarea id="in-css" class="w-full border p-2 h-24 rounded" placeholder=":root { --bg-image: url(...) }">${config.customCss}</textarea>
                `;
            } else if (type === 'preset') {
                title.innerText = 'AI é¢„è®¾ä¸è§„åˆ™';
                content.innerHTML = `
                    <label class="block text-sm mb-1">ç³»ç»Ÿæç¤ºè¯ (Prompt)</label>
                    <textarea id="in-preset" class="w-full border p-2 h-32 rounded">${config.preset}</textarea>
                `;
            }
            overlay.dataset.type = type;
        }

        function saveSettings() {
            const type = document.getElementById('modal-overlay').dataset.type;
            if (type === 'settings') {
                config.baseUrl = document.getElementById('in-url').value;
                config.apiKey = document.getElementById('in-key').value;
                config.model = document.getElementById('in-model').value;
                localStorage.setItem('baseUrl', config.baseUrl);
                localStorage.setItem('apiKey', config.apiKey);
                localStorage.setItem('model', config.model);
            } else if (type === 'beauty') {
                config.city = document.getElementById('in-city').value;
                config.weather = document.getElementById('in-weather').value;
                config.customCss = document.getElementById('in-css').value;
                document.getElementById('display-city').innerText = config.city;
                document.getElementById('display-weather').innerText = config.weather;
                applyBeauty();
            } else if (type === 'preset') {
                config.preset = document.getElementById('in-preset').value;
            }
            closeModal();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function applyBeauty() {
            let styleTag = document.getElementById('custom-style-tag');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'custom-style-tag';
                document.head.appendChild(styleTag);
            }
            styleTag.innerHTML = config.customCss;
        }

        // --- èŠå¤©é€»è¾‘ ---
        function openChat() { document.getElementById('chat-window').style.display = 'flex'; }
        function closeChat() { document.getElementById('chat-window').style.display = 'none'; }

        function sendUserMsg() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            appendMsg(text, 'right');
            chatHistory.push({ role: 'user', content: text });
            input.value = '';
        }

        function appendMsg(text, side) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `msg-bubble ${side === 'right' ? 'msg-right' : 'msg-left'}`;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function generateAI() {
            if (!config.apiKey) return alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™API Key');
            
            // æ„é€ ä¸Šä¸‹æ–‡ï¼šå‰5æ¬¡å¯¹è¯
            const context = chatHistory.slice(-5);
            const messages = [
                { role: 'system', content: config.preset + " æ‰€åœ¨åŸå¸‚: " + config.city + " å½“å‰å¤©æ°”: " + config.weather },
                ...context
            ];

            try {
                const response = await fetch(`${config.baseUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: messages,
                        max_tokens: 100
                    })
                });

                const data = await response.json();
                const reply = data.choices[0].message.content;
                
                // æ¨¡æ‹ŸçœŸäººï¼šå¦‚æœæ˜¯é•¿å¥åˆ™æ‹†åˆ†ï¼Œè¿™é‡Œç®€å•å¤„ç†å±•ç¤º
                const lines = reply.split(/[ï¼Œã€‚ï¼ï¼Ÿ\n]/).filter(s => s.trim().length > 0);
                
                for (let line of lines) {
                    await new Promise(r => setTimeout(r, 800 + Math.random() * 1000));
                    appendMsg(line.substring(0, 20), 'left');
                    chatHistory.push({ role: 'assistant', content: line });
                }
            } catch (e) {
                alert('APIè°ƒç”¨å¤±è´¥: ' + e.message);
            }
        }

        init();
    </script>
</body>
</html>
